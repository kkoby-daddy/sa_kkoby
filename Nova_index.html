<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>노바 서버 펫 계산기 1.1</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
<style>
  /* 바디 레벨 플로팅 툴팁 */
  .floating-tip{
    position: fixed; z-index: 9999; max-width: 360px;
    background:#0b1320; color:#cfe1ff; border:1px solid #2b3a55;
    border-radius:10px; padding:8px 10px; font-size:12px; line-height:1.35;
    box-shadow:0 8px 24px rgba(0,0,0,.35);
    pointer-events:none; white-space:normal; word-break:keep-all;
    opacity:0; transform: translateY(4px);
    transition: opacity .12s ease, transform .12s ease;
  }
  .floating-tip.show{ opacity:1; transform: translateY(0); }
  .floating-tip::after{
    content:""; position:absolute; width:10px; height:10px; left:50%;
    transform: translateX(-50%) rotate(45deg);
    background:#0b1320; border-left:1px solid #2b3a55; border-top:1px solid #2b3a55;
  }
  .floating-tip[data-pos="top"]::after{ bottom:-5px; }
  .floating-tip[data-pos="bottom"]::after{ top:-5px; transform: translateX(-50%) rotate(225deg); }

  :root{
    --bg:#0f1115; --panel:#161a22; --muted:#8a9099; --accent:#6aa0ff;
    --ok:#35c759; --warn:#ffb300; --bad:#ff5171; --chip:#232a36;
    --ring:#1f2530; --text:#e8ecf3; --highlight:#fff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:linear-gradient(180deg,#0f1115 0%,#0c0f14 100%); color:var(--text);
  }
  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:16px 20px; border-bottom:1px solid #232a36; background:rgba(0,0,0,.2);
    position:sticky; top:0; z-index:10;
  }
  .brand{font-weight:700; letter-spacing:.3px}
  .ver{color:var(--muted); font-size:12px; display:flex; align-items:center; gap:10px}
  .grid{ max-width:1100px; margin:20px auto; padding:0 16px; display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--panel); border:1px solid #232a36; border-radius:14px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.25);}
  .card h3{margin:4px 0 12px 0; font-size:16px}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  .col{flex:1 1 0}
  label{display:block; font-size:12px; color:var(--muted); margin:6px 0 4px 2px}
  input[type="number"], input[type="text"]{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3040;
    background:#0e1218; color:var(--text); outline:none;
  }
  input[readonly]{opacity:.7; cursor:not-allowed}
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  .btn{ padding:10px 14px; border-radius:10px; border:1px solid #334055; cursor:pointer; background:#142033; color:#cfe1ff; font-weight:600; }
  .btn:hover{filter:brightness(1.1)}
  .btn.primary{ background:linear-gradient(180deg,#2b71ff,#1d56cc); border-color:transparent; color:white;}
  .btn.ghost{ background:transparent;}
  .btn-sm{padding:6px 10px; font-size:12px; border-radius:8px}
  .muted{color:var(--muted)}
  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{ background:var(--chip); color:#cfd6e3; border:1px solid #2b3242; border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer; }
  .chip.on{outline:2px solid var(--accent)}
  .kbd{display:inline-block; border:1px solid #404a5e; border-bottom-width:3px; padding:2px 6px; border-radius:6px; background:#0e131a; font-weight:700}
  .chooser{display:grid; grid-template-columns: 1fr; gap:8px}
  .list{ max-height:260px; overflow:auto; border:1px solid #2a3040; border-radius:10px; padding:6px; background:#0d1117; }
  .item{padding:8px 10px; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition: background .12s ease, outline-color .12s ease; }
  .item:hover{background:#19202b}
  .item.selected{ background:#1b2535; outline:2px solid #30518d; }
  .tags{display:flex; gap:6px; align-items:center}
  .tag{font-size:11px;border:1px solid #2b3242;border-radius:999px;padding:2px 8px}
  .tag.ok{border-color:#275a34; background:#102214; color:#35c759}
  .tag.warn{border-color:#7a5b0e; background:#241a05; color:#ffb300}
  .tag.rank8{border-color:#2b4a82; background:#0d1a33; color:#88b5ff}
  .kpis{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px}
  @media (max-width: 720px){ .kpis{grid-template-columns: 1fr} }
  .kpi{ display:flex; gap:14px; align-items:center; border:1px solid #2a3040; border-radius:14px; padding:14px; background:radial-gradient(120px 120px at 20% -10%, #11224444, transparent); }
  .ring{width:60px; height:60px; border-radius:50%; background:conic-gradient(var(--accent) 0deg, var(--accent) var(--p,0deg), var(--ring) var(--p,0deg)); display:grid; place-items:center}
  .ring::after{content:""; width:48px; height:48px; background:#0c1016; border-radius:50%; display:block}
  .kpi strong{font-size:20px; color:var(--highlight)}
  .kpi small{display:block; color:var(--muted)}
  .table{width:100%; border-collapse:collapse; font-size:13px}
  .table th,.table td{border-bottom:1px solid #262d3a; padding:8px 6px; text-align:right}
  .table th:first-child,.table td:first-child{text-align:left}
  .badge{display:inline-block; min-width:34px; text-align:center; padding:2px 6px; border-radius:6px; background:#223; border:1px solid #356}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .footer{max-width:1100px; margin:8px auto 30px; padding:0 16px; color:var(--muted); font-size:12px}
  .imgbox{width:100%; aspect-ratio: 16/9; border:1px dashed #334055; border-radius:12px; display:grid; place-items:center; background:#0d1117; overflow:hidden;}
  .imgbox img{width:100%; height:100%; object-fit:cover; display:block}
  .stepper{display:flex; gap:6px; margin-top:6px}
</style>
</head>
<body>
<header>
  <div class="brand">NOVA SERVER PET Calculator</div>
  <div class="ver">
    <span>1.1 · <span class="muted">문의사항 : 인게임&디스코드 과장</span></span>
    <button class="btn ghost" id="btnAdmin">★</button>
  </div>
</header>

<div class="grid">
  <!-- 좌: 펫 선택 -->
  <section class="card">
    <h3>① 펫 선택</h3>
    <div class="row">
      <div class="col chooser">
        <label>초성 키패드</label>
        <div id="chosung" class="chips"></div>

        <div class="row" style="margin-top:6px; align-items:center">
          <span class="muted" style="min-width:78px">선택한 초성</span>
          <div id="chosungTokens" class="chips" style="min-height:28px"></div>
        </div>

        <div class="row" style="margin-top:8px">
          <div class="col">
            <input type="text" id="petSearch" placeholder="이름으로 검색 (예: 카르곤, 반기노)" />
          </div>
          <button class="btn" id="btnClear">지우기</button>
        </div>
        <div class="list" id="petList"></div>
      </div>
    </div>
    <p class="muted" style="margin-top:8px">팁: 초성만 두세 번 눌러도 후보가 빠르게 걸러집니다. (예: 반기노 = <span class="kbd">ㅂ</span>→<span class="kbd">ㄱ</span>)</p>
  </section>

  <!-- 우: 표기 S0 / Sg + 관측 입력 -->
  <section class="card">
    <h3>② 표기치 & 관측치 입력</h3>

    <div class="row">
      <div class="col">
        <label>표기 초기치 S0 (체/공/방/순)</label>
        <div class="row">
          <div class="col"><input type="number" id="s0_hp"  step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="s0_atk" step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="s0_def" step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="s0_agi" step="0.01" placeholder="—" readonly /></div>
        </div>

        <label style="margin-top:10px">표기 성장치 Sg (체/공/방/순)</label>
        <div class="row">
          <div class="col"><input type="number" id="sg_hp"  step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="sg_atk" step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="sg_def" step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="sg_agi" step="0.01" placeholder="—" readonly /></div>
        </div>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid #2a3040; margin:14px 0" />

    <div class="row">
      <div class="col">
        <label>내 펫 레벨1 관측 표기치 (정수) — 체/공/방/순</label>
        <div class="row">
          <div class="col">
            <input type="number" id="obs_hp"  step="1" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_hp" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_hp" data-delta="1">+1</button>
            </div>
          </div>
          <div class="col">
            <input type="number" id="obs_atk" step="1" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_atk" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_atk" data-delta="1">+1</button>
            </div>
          </div>
          <div class="col">
            <input type="number" id="obs_def" step="1" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_def" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_def" data-delta="1">+1</button>
            </div>
          </div>
          <div class="col">
            <input type="number" id="obs_agi" step="1" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_agi" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_agi" data-delta="1">+1</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnCalc">계산</button>
      <button class="btn ghost" id="btnReset">리셋</button>
      <span class="muted" style="margin-left:auto">스크롤 업/다운으로 수치 조정 가능</span>
    </div>
  </section>

  <!-- 좌하단: KPI 강조 -->
  <section class="card" id="resultCard">
    <h3>③ 결과</h3>
    <div class="kpis">
      <div class="kpi">
        <div class="ring" id="ringSuccess" style="--p:0deg"></div>
        <div>
          <strong id="kpiSuccess">—%</strong>
          <small>환각(8등급) 확률</small>
        </div>
      </div>
      <div class="kpi">
        <div class="ring" id="ringAppear" style="--p:0deg"></div>
        <div>
          <strong id="kpiAppear">—%</strong>
          <small>출현 확률</small>
        </div>
      </div>
      <div class="kpi">
        <div class="ring" style="--p:360deg; background:conic-gradient(#888 360deg, #888 360deg, var(--ring) 360deg)"></div>
        <div>
          <strong id="kpiTries">—</strong>
          <small>성공 기대값(시도)</small>
        </div>
      </div>
    </div>

    <div style="margin-top:14px">
      <div class="row">
        <div class="col"><span class="muted">총 경우의 수:</span> <span class="badge" id="totMatches">—</span></div>
        <div class="col"><span class="muted">환각 매칭:</span> <span class="badge" id="rank8Matches">—</span></div>
        <div class="col"><span class="muted">전수(고정):</span> <span class="badge">178,750</span></div>
      </div>
    </div>

    <details style="margin-top:12px">
      <summary>등급 분포 자세히 보기</summary>
      <div id="dist"></div>
    </details>
  </section>

  <!-- 우하단: 이미지 공간 -->
  <section class="card">
    <h3>본 계산기는 오픈 소스로 만들어졌습니다.</h3>
    <div class="imgbox">
      <img id="dinoImg" src="https://raw.githubusercontent.com/Kokudas/Kokudas.github.io/main/67269_179791_1130-Photoroom.png" alt="StoneAge Dino" loading="lazy" decoding="async"/>
    </div>
    <p class="muted" style="margin-top:8px">Made by. 과장 (kokodas#0339) </p>
  </section>
</div>

<div class="footer">
  <p>· “환각(8등급)”은 베이스 합계가 <b>+8</b>인 경우만 집계합니다. (베이스 각 항목 범위 −2..+2, 보너스 총합 10 분배)</p>
  <p>· 이 계산기는 해피 서버 페트 및 짜얄 계산기 데이터 계수 기반으로 제작되었으며, 이에 따라 결과값은 단순 재미로만 봐 주시길 바랍니다.</p>
  <p>· 계산기 사용 중 예외사항이나 에러가 있다면, 디스코드 인게임닉 [과장] 으로 연락 주세요. </p>
</div>

<script>
/* ========= 서버 경로 ========= */ 
const LOCAL_PETS = "data/pets.json";
const GH_OWNER  = "kokudas";
const GH_REPO   = "kokudas.github.io";
const GH_BRANCH = "main";
const PETS_PATH = "data/pets.json";
const REMOTE_PETS = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}/${PETS_PATH}`;

/* ========= Rank8 JSON (우선순위 로드) ========= */
const R8_JSON_CANDIDATES = [
  "data/guaranteed_rank8.full.json",
  "data/guaranteed_rank8.min.json",
  "guaranteed_rank8.sample8.json"
];

/* ========= 상수 ========= */
const LS_TABLE = "novaPetTable_cache";
const TOTAL = 178750;
const ADMIN_PASS = "kokudas";

/* ========= 전역 ========= */
let GLOBAL_TABLE = {};
let ALL_NAMES = [];
let R8MAP = {}; // name -> {count, obs_100_rank8: [[hp,atk,def,agi],...]}

/* ========= 유틸 ========= */
function getJSONLS(key, fallback={}){ try{ return JSON.parse(localStorage.getItem(key)||JSON.stringify(fallback)); }catch{ return fallback; } }
function setJSONLS(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function fetchJSON(url){ return fetch(url+`?v=${Date.now()}`,{cache:"no-store"}).then(r=>{ if(!r.ok) throw 0; return r.json();}); }
function fmtPct(x){
  if(!Number.isFinite(x)) return "—%";
  if(x === 0) return "0.0000%";
  if(x < 0.001) return x.toFixed(6) + "%";
  return x.toFixed(4) + "%";
}

/* ========= 초성(문자 → 초성) 유틸 ========= */
const CHO_CODE = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
const CHO_SIMPLE = (c)=>({"ㄲ":"ㄱ","ㄸ":"ㄷ","ㅃ":"ㅂ","ㅆ":"ㅅ","ㅉ":"ㅈ"}[c]||c);
function getChosung(str){
  let out="";
  for(const ch of str){
    const code = ch.charCodeAt(0);
    if(code<0xAC00 || code>0xD7A3){ out+=ch; continue; }
    const idx = Math.floor((code - 0xAC00) / 588);
    out += CHO_SIMPLE(CHO_CODE[idx]);
  }
  return out;
}

/* ========= 원격 로드 ========= */
async function loadGlobalTable(){
  try{
    // 1차: raw.githubusercontent 경로
    const obj = await fetchJSON(REMOTE_PETS);
    if(typeof obj!=="object" || Array.isArray(obj)) throw 0;
    GLOBAL_TABLE = obj; setJSONLS(LS_TABLE, obj);
  }catch{
    try{
      // 2차: 같은 도메인의 /data/pets.json (깃허브 페이지/로컬 호환)
      const obj = await fetchJSON(LOCAL_PETS);
      if(typeof obj!=="object" || Array.isArray(obj)) throw 0;
      GLOBAL_TABLE = obj; setJSONLS(LS_TABLE, obj);
    }catch{
      // 3차: 로컬스토리지 캐시
      GLOBAL_TABLE = getJSONLS(LS_TABLE, {});
      console.warn("[pets] remote/local 모두 실패 → localStorage 캐시 사용");
    }
  }
  ALL_NAMES = Object.keys(GLOBAL_TABLE).sort((a,b)=>a.localeCompare(b,'ko'));
}
async function loadRank8Map(){
  for(const path of R8_JSON_CANDIDATES){
    try{
      const m = await fetchJSON(path);
      if (typeof m==="object" && !Array.isArray(m)){
        R8MAP = m;
        console.log("[Rank8] loaded:", path, "keys:", Object.keys(R8MAP).length);
        return;
      }
    }catch{ /* try next */ }
  }
  R8MAP = {};
  console.log("[Rank8] no file found; badge disabled");
}

/* ========= DOM ========= */
const chosungBar = document.getElementById('chosung');
const chosungTokens = document.getElementById('chosungTokens');
const petList = document.getElementById('petList');
const petSearch = document.getElementById('petSearch');

const s0hp = document.getElementById('s0_hp');
const s0atk= document.getElementById('s0_atk');
const s0def= document.getElementById('s0_def');
const s0agi= document.getElementById('s0_agi');

const sghp = document.getElementById('sg_hp');
const sgatk= document.getElementById('sg_atk');
const sgdef= document.getElementById('sg_def');
const sgagi= document.getElementById('sg_agi');

const obshp = document.getElementById('obs_hp');
const obsatk= document.getElementById('obs_atk');
const obsdef= document.getElementById('obs_def');
const obsagi= document.getElementById('obs_agi');

const kpiSuccess = document.getElementById('kpiSuccess');
const kpiAppear  = document.getElementById('kpiAppear');
const kpiTries   = document.getElementById('kpiTries');
const ringSuccess= document.getElementById('ringSuccess');
const ringAppear = document.getElementById('ringAppear');
const totMatches = document.getElementById('totMatches');
const rank8Matches = document.getElementById('rank8Matches');
const distBox = document.getElementById('dist');

const btnCalc = document.getElementById('btnCalc');
const btnReset= document.getElementById('btnReset');
const btnClear= document.getElementById('btnClear');

let currentChosung="";
let selectedName=null;
let selectedRow=null;
let selectedItemEl=null; // 선택 하이라이트 유지

// ===== 바디 레벨 툴팁 =====
const tipEl = document.createElement('div');
tipEl.className = 'floating-tip';
document.body.appendChild(tipEl);
let tipTimer = null;

function hideTip(){ tipEl.classList.remove('show'); }
function showTip(target){
  const text = target.getAttribute('data-tip');
  if(!text){ hideTip(); return; }
  const lines = String(text).split('\n');
  tipEl.textContent = '';
  lines.forEach((line,i)=>{
    tipEl.appendChild(document.createTextNode(line));
    if(i < lines.length-1) tipEl.appendChild(document.createElement('br'));
  });
  tipEl.classList.add('show');
  tipEl.style.left = '-9999px'; tipEl.style.top  = '-9999px'; tipEl.removeAttribute('data-pos');
  tipEl.getBoundingClientRect();
  const rect = target.getBoundingClientRect();
  const tw = tipEl.offsetWidth, th = tipEl.offsetHeight;
  const margin = 8;
  let pos = 'top';
  let left = rect.left + rect.width/2 - tw/2;
  left = Math.max(8, Math.min(left, window.innerWidth - tw - 8));
  let top = rect.top - th - margin;
  if(top < 6){ top = rect.bottom + margin; pos = 'bottom'; }
  tipEl.dataset.pos = pos;
  tipEl.style.left = `${Math.round(left)}px`;
  tipEl.style.top  = `${Math.round(top)}px`;
}
petList.addEventListener('mouseover', (e)=>{
  const t = e.target.closest('.tag.tip'); if(!t) return; showTip(t);
}, true);
petList.addEventListener('mouseout', (e)=>{
  const t = e.target.closest('.tag.tip'); if(!t) return; hideTip();
}, true);
petList.addEventListener('focusin', (e)=>{
  const t = e.target.closest('.tag.tip'); if(!t) return; showTip(t);
});
petList.addEventListener('focusout', (e)=>{
  const t = e.target.closest('.tag.tip'); if(!t) return; hideTip();
});
petList.addEventListener('touchstart', (e)=>{
  const t = e.target.closest('.tag.tip'); if(!t) return; e.stopPropagation(); showTip(t);
  clearTimeout(tipTimer); tipTimer = setTimeout(hideTip, 1800);
}, {passive:true});
window.addEventListener('scroll', hideTip, true);
window.addEventListener('resize', hideTip);

/* ===== 관리자 버튼 ===== */
document.getElementById('btnAdmin').addEventListener('click', ()=>{
  const pw = prompt('관리자 암호를 입력하세요.');
  if (pw === null) return;
  if (pw === ADMIN_PASS) location.href = "./admin.html";
  else alert('암호가 올바르지 않습니다.');
});

/* ========= 초성 키패드 ========= */
const CHO = ['ㄱ','ㄴ','ㄷ','ㄹ','ㅁ','ㅂ','ㅅ','ㅇ','ㅈ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];

function renderChosungTokens(){
  chosungTokens.innerHTML = "";
  for(const ch of currentChosung){
    const t = document.createElement('div');
    t.className = 'chip'; t.style.cursor = 'default'; t.textContent = ch;
    chosungTokens.appendChild(t);
  }
}
CHO.forEach(c=>{
  const chip=document.createElement('div');
  chip.className='chip'; chip.textContent=c;
  chip.addEventListener('click', ()=>{
    currentChosung += c;
    renderPetList();
    renderChosungTokens();
    Array.from(chosungBar.children).forEach(el=>el.classList.remove('on'));
    chip.classList.add('on');
  });
  chosungBar.appendChild(chip);
});
petSearch.addEventListener('input', renderPetList);

/* ========= 목록 ========= */
function renderPetList(){
  const kw = (petSearch.value||"").trim();
  const names = ALL_NAMES.length? ALL_NAMES : Object.keys(GLOBAL_TABLE);
  const list = names.filter(n=>{
    const a = kw? n.includes(kw): true;
    const b = currentChosung? getChosung(n).startsWith(currentChosung): true;
    return a && b;
  });

  petList.innerHTML="";
  if(list.length===0){
    const d=document.createElement('div'); d.className='item'; d.textContent='결과 없음';
    petList.appendChild(d);
    return;
  }

  list.forEach(n=>{
    const div=document.createElement('div'); div.className='item';

    const left=document.createElement('div'); left.textContent = n;
    const right=document.createElement('div'); right.className="tags";

    // 등록/미등록 배지
    const tag1=document.createElement('span');
    tag1.className='tag ' + (GLOBAL_TABLE[n]?'ok':'warn');
    tag1.textContent = GLOBAL_TABLE[n] ? '등록됨' : '미등록';
    right.appendChild(tag1);

    // 8등급 보장 배지
    const r8 = R8MAP[n];
    if (r8 && (Array.isArray(r8.obs_100_rank8) ? r8.obs_100_rank8.length : (r8.length||0))) {
      const sets = Array.isArray(r8.obs_100_rank8) ? r8.obs_100_rank8 : r8;
      const tag2 = document.createElement('span');
      tag2.className = 'tag rank8 tip';
      tag2.textContent = '100%';

      const maxShow = 12;
      const preview = sets.slice(0, maxShow).map(a=>`(${a[0]},${a[1]},${a[2]},${a[3]})`).join(' · ');
      const more = sets.length>maxShow ? ` 외 ${sets.length-maxShow}세트` : '';
      const tipText = `8등급 보장 초기치\n${preview}${more}`;
      tag2.setAttribute('data-tip', tipText);

      tag2.tabIndex = 0;
      const stop = (e)=>{ e.stopPropagation(); };
      tag2.addEventListener('click', stop);
      tag2.addEventListener('touchstart', stop, {passive:true});
      tag2.addEventListener('click', ()=>{
        tag2.classList.add('show');
        setTimeout(()=>tag2.classList.remove('show'), 1800);
      });

      right.appendChild(tag2);
    }

    div.appendChild(left);
    div.appendChild(right);
    div.addEventListener('click', ()=>{
      if(selectedItemEl) selectedItemEl.classList.remove('selected');
      div.classList.add('selected');
      selectedItemEl = div;
      selectPetName(n);
    });
    if (n === selectedName) { div.classList.add('selected'); selectedItemEl = div; }
    petList.appendChild(div);
  });

  renderChosungTokens();
}

/* ========= 펫 선택 ========= */
function selectPetName(n){
  selectedName=n;
  selectedRow=GLOBAL_TABLE[n]||null;

  if(selectedRow?.s0){
    s0hp.value=selectedRow.s0.hp??""; s0atk.value=selectedRow.s0.atk??"";
    s0def.value=selectedRow.s0.def??""; s0agi.value=selectedRow.s0.agi??"";
  }else{ s0hp.value=s0atk.value=s0def.value=s0agi.value=""; }

  if(selectedRow?.sg){
    sghp.value=selectedRow.sg.hp??""; sgatk.value=selectedRow.sg.atk??"";
    sgdef.value=selectedRow.sg.def??""; sgagi.value=selectedRow.sg.agi??"";
  }else{ sghp.value=sgatk.value=sgdef.value=sgagi.value=""; }

  if(selectedRow?.s0){
    obshp.value = Math.floor(selectedRow.s0.hp??NaN)||"";
    obsatk.value= Math.floor(selectedRow.s0.atk??NaN)||"";
    obsdef.value= Math.floor(selectedRow.s0.def??NaN)||"";
    obsagi.value= Math.floor(selectedRow.s0.agi??NaN)||"";
  }else{
    obshp.value=obsatk.value=obsdef.value=obsagi.value="";
  }
  showKpis(null);
}

/* ========= KPI 렌더 ========= */
function showKpis(res){
  if(!res){
    kpiSuccess.textContent = "—%";
    kpiAppear .textContent = "—%";
    kpiTries  .textContent = "—";
    ringSuccess.style.setProperty("--p","0deg");
    ringAppear .style.setProperty("--p","0deg");
    totMatches.textContent = "—";
    rank8Matches.textContent = "—";
    distBox.innerHTML = "";
    return;
  }
  const matches = res.matches|0;
  const rank8   = res.rank8|0;
  const appear = matches/TOTAL*100;
  const successPct = matches? (rank8/matches*100): 0;
  const tries = successPct>0? (100/successPct) : Infinity;

  kpiSuccess.textContent = fmtPct(successPct);
  kpiAppear .textContent = fmtPct(appear);
  kpiTries  .textContent = (isFinite(tries) ? tries.toFixed(2) : "—");

  ringSuccess.style.setProperty("--p", (360 * successPct / 100) + "deg");
  ringAppear .style.setProperty("--p", (360 * appear     / 100) + "deg");

  totMatches.textContent   = matches.toLocaleString();
  rank8Matches.textContent = rank8.toLocaleString();

  const entries = Object.entries(res.dist)
    .map(([r,c]) => ({r:parseInt(r,10), c}))
    .sort((a,b) => b.r - a.r || b.c - a.c);

  let html = `<table class="table"><thead><tr><th>등급(베이스합)</th><th>건수</th><th>비율</th></tr></thead><tbody>`;
  const total = matches || 1;
  entries.forEach(e=>{
    const pct = (e.c/total*100).toFixed(2);
    const cls = (e.r===8 ? "ok" : (e.r>=5 ? "warn" : ""));
    html += `<tr><td class="${cls}">${e.r}</td><td>${e.c.toLocaleString()}</td><td>${pct}%</td></tr>`;
  });
  html += `</tbody></table>`;
  distBox.innerHTML = html;
}

/* ========= 관측치 편의 ========= */
function enableWheelStep(el){
  el.addEventListener('wheel',(e)=>{
    if(document.activeElement!==el) return;
    e.preventDefault();
    const delta = e.deltaY<0? 1 : -1;
    const curr = parseInt(el.value||"0",10);
    el.value = String(curr + delta);
  }, {passive:false});
}
[obsatk,obshp,obsdef,obsagi].forEach(enableWheelStep);
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-delta][data-target]'); if(!btn) return;
  const id = btn.getAttribute('data-target'); const delta = parseInt(btn.getAttribute('data-delta'),10);
  const input=document.getElementById(id); if(!input) return;
  const curr=parseInt(input.value||"0",10); input.value=String(curr+delta);
});

/* ========= k/u 추정 ========= */
const ESET = [575, 555, 535, 515, 495, 475, 455, 435];

function solveUFromSG_JJYAL(SG, e){
  try{
    if(!SG || ![SG.hp,SG.atk,SG.def,SG.agi].every(Number.isFinite)) return null;
    Decimal.set({ precision:50, rounding: Decimal.ROUND_HALF_UP });

    const eD = new Decimal(e);
    const f  = eD.dividedBy(10000);
    const d  = new Decimal(SG.agi).times(10000).dividedBy(eD).minus(2.5);
    const dRound = d.round();
    const dPlus25 = dRound.plus(2.5);

    const rhs1 = new Decimal(SG.hp).minus( dPlus25.times(f) ).dividedBy(f);
    const rhs2 = new Decimal(SG.atk).minus( dPlus25.times(f).times(0.05) ).dividedBy(f);
    const rhs3 = new Decimal(SG.def).minus( dPlus25.times(f).times(0.05) ).dividedBy(f);

    let A = [
      [ new Decimal(4),   new Decimal(1),   new Decimal(1),   rhs1 ],
      [ new Decimal(0.1), new Decimal(1),   new Decimal(0.1), rhs2 ],
      [ new Decimal(0.1), new Decimal(0.1), new Decimal(1),   rhs3 ],
    ];
    for(let i=0;i<3;i++){
      let mr=i; let mv=A[i][i].abs();
      for(let j=i+1;j<3;j++){ const t=A[j][i].abs(); if(t.greaterThan(mv)){mr=j; mv=t;} }
      if(mr!==i){ const tmp=A[i]; A[i]=A[mr]; A[mr]=tmp; }
      const piv=A[i][i];
      for(let j=i;j<4;j++) A[i][j]=A[i][j].dividedBy(piv);
      for(let k=0;k<3;k++){
        if(k===i) continue;
        const fac=A[k][i];
        for(let j=i;j<4;j++) A[k][j]=A[k][j].minus( fac.times(A[i][j]) );
      }
    }
    const aPrime=A[0][3], bPrime=A[1][3], cPrime=A[2][3];

    const u_hp  = aPrime.minus(2.5).round();
    const u_atk = bPrime.minus(2.5).round();
    const u_def = cPrime.minus(2.5).round();
    const u_agi = dRound;

    const r2 = x => new Decimal(x).toDecimalPlaces(2);
    const hp_chk  = r2( f.times( u_hp.plus(2.5).times(4).plus(u_atk.plus(2.5)).plus(u_def.plus(2.5)).plus(u_agi.plus(2.5)) ) );
    const atk_chk = r2( f.times( u_hp.plus(2.5).times(0.1).plus(u_atk.plus(2.5)).plus(u_def.plus(2.5).times(0.1)).plus(u_agi.plus(2.5).times(0.05)) ) );
    const def_chk = r2( f.times( u_hp.plus(2.5).times(0.1).plus(u_atk.plus(2.5).times(0.1)).plus(u_def.plus(2.5)).plus(u_agi.plus(2.5).times(0.05)) ) );
    const agi_chk = r2( f.times( u_agi.plus(2.5) ) );

    const err = hp_chk.minus(r2(SG.hp)).abs()
               .plus(atk_chk.minus(r2(SG.atk)).abs())
               .plus(def_chk.minus(r2(SG.def)).abs())
               .plus(agi_chk.minus(r2(SG.agi)).abs());

    return { u:{hp:+u_hp, atk:+u_atk, def:+u_def, agi:+u_agi}, e, sg_err:+err };
  }catch(e){ return null; }
}

function s0_from_k_u_jjyal(k,u){
  const fac = k/100;
  const vhp  = (u.hp + 2.5) * fac;
  const vatk = (u.atk+ 2.5) * fac;
  const vdef = (u.def+ 2.5) * fac;
  const vagi = (u.agi+ 2.5) * fac;
  const s_hp = Math.floor(vhp*4 + vatk + vdef + vagi);
  const s_atk= Math.floor(vhp*0.1 + vatk + vdef*0.1 + vagi*0.05);
  const s_def= Math.floor(vhp*0.1 + vatk*0.1 + vdef + vagi*0.05);
  const s_agi= Math.floor(vagi);
  return [s_hp,s_atk,s_def,s_agi];
}
function fitKFromS0_JJYAL(S0int,u){
  let best=null;
  for(let k=10;k<=100;k++){
    const s = s0_from_k_u_jjyal(k,u);
    const l1 = Math.abs(s[0]-S0int[0]) + Math.abs(s[1]-S0int[1]) + Math.abs(s[2]-S0int[2]) + Math.abs(s[3]-S0int[3]);
    const ok = (l1===0);
    if(!best || (ok && !best.ok) || (!best.ok && l1<best.l1)) best={k,l1,ok};
    if(ok) break;
  }
  return best;
}
function inferKU_JJYAL(S0, SG){
  const S0int = S0.map(x=>Math.floor(x));
  let best=null;
  for(const e of ESET){
    const sol = solveUFromSG_JJYAL(SG, e);
    if(!sol) continue;
    const fit = fitKFromS0_JJYAL(S0int, sol.u);
    if(!fit) continue;
    const score = (fit.ok?0:1000) + fit.l1*10 + (sol.sg_err||0);
    const cand = {k:fit.k, u:sol.u, e, sg_err:sol.sg_err, s0_l1:fit.l1, s0_ok:fit.ok, score};
    if(!best || cand.score<best.score) best=cand;
  }
  return best;
}

/* ========= 엔진(합산 후 floor) ========= */
function enumerate_jjyal(pku, obs){
  const k = new Decimal(pku.k);
  const fac = k.dividedBy(100);
  const u = pku.u;

  let matches = 0, rank8 = 0;
  const dist = {};

  for(let ar=-2; ar<=2; ar++){
    for(let dr=-2; dr<=2; dr++){
      for(let gr=-2; gr<=2; gr++){
        for(let hr=-2; hr<=2; hr++){
          for(let ab=0; ab<=10; ab++){
            for(let db=0; db<=10; db++){
              for(let gb=0; gb<=10; gb++){
                const hb = 10 - ab - db - gb;
                if(hb < 0 || hb > 10) continue;

                const baseA = new Decimal(u.atk + ar + ab);
                const baseD = new Decimal(u.def + dr + db);
                const baseG = new Decimal(u.agi + gr + gb);
                const baseH = new Decimal(u.hp  + hr + hb);

                const iA = baseA.times(fac);
                const iD = baseD.times(fac);
                const iG = baseG.times(fac);
                const iH = baseH.times(fac);

                const calcAtk = iH.times(0.1).plus(iA).plus(iD.times(0.1)).plus(iG.times(0.05)).floor().toNumber();
                const calcDef = iH.times(0.1).plus(iA.times(0.1)).plus(iD).plus(iG.times(0.05)).floor().toNumber();
                const calcAgi = iG.floor().toNumber();
                const calcHp  = iH.times(4).plus(iA).plus(iD).plus(iG).floor().toNumber();

                if(calcAtk===obs[1] && calcDef===obs[2] && calcAgi===obs[3] && calcHp===obs[0]){
                  matches++;
                  const r = ar + dr + gr + hr;
                  dist[r] = (dist[r]||0) + 1;
                  if(r === 8) rank8++;
                }
              }
            }
          }
        }
      }
    }
  }
  return {matches, rank8, dist};
}

/* ========= 계산 ========= */
btnCalc.addEventListener('click', async ()=>{
  if(!selectedName){ alert("펫을 먼저 선택하세요."); return; }
  const obs=[obshp,obsatk,obsdef,obsagi].map(e=>parseInt(e.value,10));
  if(obs.some(v=>!Number.isFinite(v))){ alert("관측 표기치(정수)를 모두 입력하세요."); return; }

  const row=GLOBAL_TABLE[selectedName]||{};
  if(!row?.s0 || !row?.sg){ alert("이 펫은 S0/SG가 등록되어 있지 않습니다."); return; }

  let k=row.k, u=row.u;
  if(!(Number.isFinite(k) && u && [u.hp,u.atk,u.def,u.agi].every(Number.isFinite))){
    const S0=[row.s0.hp, row.s0.atk, row.s0.def, row.s0.agi];
    const SG=row.sg;
    const fit = inferKU_JJYAL(S0, SG);
    if(!fit){ alert("k/u 추정 실패: S0/SG를 확인하세요."); return; }
    k=fit.k; u=fit.u;
  }
  const res = enumerate_jjyal({k,u}, obs);
  showKpis(res);
});

btnReset.addEventListener('click', ()=>{
  selectedName=null; selectedRow=null;
  petSearch.value=""; currentChosung="";
  Array.from(chosungBar.children).forEach(el=>el.classList.remove('on'));
  petList.querySelectorAll('.item.selected').forEach(el=>el.classList.remove('selected'));
  selectedItemEl = null;
  renderPetList();
  [s0hp,s0atk,s0def,s0agi,sghp,sgatk,sgdef,sgagi,obshp,obsatk,obsdef,obsagi].forEach(i=>i.value="");
  showKpis(null);
});
btnClear.addEventListener('click', ()=>{
  petSearch.value=""; currentChosung="";
  Array.from(chosungBar.children).forEach(el=>el.classList.remove('on'));
  petList.querySelectorAll('.item.selected').forEach(el=>el.classList.remove('selected'));
  selectedItemEl = null;
  renderPetList();
});

/* ========= 부팅 ========= */
(async function init(){
  console.log("[init] start");
  await loadGlobalTable();
  await loadRank8Map();
  console.log("[init] pets:", Object.keys(GLOBAL_TABLE).length, "rank8 keys:", Object.keys(R8MAP).length);
  renderPetList();
})();
</script>
</body>
</html>
