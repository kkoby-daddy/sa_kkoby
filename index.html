<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>꼬비아빠 놀이터</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
<style>
  :root{
    --bg:#0f1115; --panel:#161a22; --muted:#8a9099; --accent:#6aa0ff;
    --ok:#35c759; --warn:#ffb300; --bad:#ff5171; --chip:#232a36;
    --ring:#1f2530; --text:#e8ecf3; --highlight:#fff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:var(--bg); color:var(--text);
    transition: background-color .3s ease, color .3s ease;
  }
  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:16px 20px; border-bottom:1px solid #232a36; background:rgba(0,0,0,.2);
    position:sticky; top:0; z-index:10;
  }
  .brand{font-weight:700; letter-spacing:.3px}
  .ver{color:var(--muted); font-size:12px; display:flex; align-items:center; gap:10px}
  .grid{ max-width:1300px; margin:20px auto; padding:0 16px; display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--panel); border:1px solid #232a36; border-radius:14px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.25);}
  .full-width { grid-column: 1 / -1; }
  .card h3{margin:4px 0 12px 0; font-size:16px}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  .col{flex:1 1 0}
  label{display:block; font-size:12px; color:var(--muted); margin:6px 0 4px 2px}
  input[type="number"], input[type="text"]{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3040;
    background:#0e1218; color:var(--text); outline:none;
  }
  input[readonly]{opacity:.7; cursor:not-allowed}
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  .btn{ padding:10px 14px; border-radius:10px; border:1px solid #334055; cursor:pointer; background:#142033; color:#cfe1ff; font-weight:600; }
  .btn:hover{filter:brightness(1.1)}
  .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: none; }
  .btn.primary{ background:linear-gradient(180deg,#2b71ff,#1d56cc); border-color:transparent; color:white;}
  .btn.ghost{ background:transparent;}
  .btn-sm{padding:6px 10px; font-size:12px; border-radius:8px}
  .btn-group {display: flex;}
  .btn-group .btn{ border-radius: 0; margin-left: -1px; }
  .btn-group .btn:first-child{ border-top-left-radius: 10px; border-bottom-left-radius: 10px; margin-left: 0;}
  .btn-group .btn:last-child{ border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
  .btn-group .btn.active{ background:linear-gradient(180deg,#2b71ff,#1d56cc); border-color:transparent; color:white; filter: none; }
  .muted{color:var(--muted)}
  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{ background:var(--chip); color:#cfd6e3; border:1px solid #2b3242; border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer; }
  .chip.on{outline:2px solid var(--accent)}
  .kbd{display:inline-block; border:1px solid #404a5e; border-bottom-width:3px; padding:2px 6px; border-radius:6px; background:#0e131a; font-weight:700}
  .chooser{display:grid; grid-template-columns: 1fr; gap:8px}
  .list{ max-height:260px; overflow:auto; border:1px solid #2a3040; border-radius:10px; padding:6px; background:#0d1117; }
  .item{padding:8px 10px; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition: background .12s ease, outline-color .12s ease; }
  .item:hover{background:#19202b}
  .item.selected{ background:#1b2535; outline:2px solid #30518d; }
  .tags{display:flex; gap:6px; align-items:center}
  .tag{font-size:11px;border:1px solid #2b3242;border-radius:999px;padding:2px 8px}
  .tag.ok{border-color:#275a34; background:#102214; color:#35c759}
  .tag.warn{border-color:#7a5b0e; background:#241a05; color:#ffb300}
  .kpis{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px}
  @media (max-width: 720px){ .kpis{grid-template-columns: 1fr} }
  .kpi{ display:flex; gap:14px; align-items:center; border:1px solid #2a3040; border-radius:14px; padding:14px; background:radial-gradient(120px 120px at 20% -10%, #11224444, transparent); }
  .kpi strong{font-size:20px; color:var(--highlight)}
  .kpi small{display:block; color:var(--muted)}
  .table{width:100%; border-collapse:collapse; font-size:13px}
  .table th,.table td{border-bottom:1px solid #262d3a; padding:8px 6px; text-align:right}
  .table th:first-child,.table td:first-child{text-align:left}
  .badge{display:inline-block; min-width:34px; text-align:center; padding:2px 6px; border-radius:6px; background:#223; border:1px solid #356}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .footer{max-width:1100px; margin:8px auto 30px; padding:0 16px; color:var(--muted); font-size:12px; text-align: center;}
  .stepper{display:flex; gap:6px; margin-top:6px}

  /* --- Transitions --- */
  body, .card, header, input, .btn, .chip, .list, .item, .badge, .table th, .table td, hr {
    transition: background-color .3s ease, color .3s ease, border-color .3s ease;
  }

  /* --- Light Mode --- */
  body.light {
    --bg: #e2e8f0; --panel: #ffffff; --muted: #64748b; --accent: #2563eb;
    --ok: #16a34a; --warn: #f59e0b; --bad: #dc2626; --chip: #f1f5f9;
    --ring: #cbd5e1; --text: #1e293b; --highlight: #000000;
  }
  body.light header{ background: rgba(255,255,255,0.7); backdrop-filter: blur(8px); border-color: #d1d5db; }
  body.light .card { border-color: #d1d5db; box-shadow: 0 6px 24px rgba(0,0,0,.07); }
  body.light hr { border-top-color: #e2e8f0; }
  body.light input[type="number"], body.light input[type="text"], body.light .list { background: #f8fafc; border-color: #cbd5e1; }
  body.light .item:hover{background:#f1f5f9}
  body.light .item.selected{ background:#e2e8f0; outline-color:#9ca3af; }
  body.light .btn{ background:#f1f5f9; border-color:#cbd5e1; color: var(--text); }
  body.light .btn:hover{filter:brightness(.98)}
  body.light .btn.primary, body.light .btn-group .btn.active { background:linear-gradient(180deg,#2563eb,#1d4ed8); border-color:transparent; color:white; }
  body.light .chip{ background:#f8fafc; border-color:#cbd5e1; }
  body.light .kbd { background: #f1f5f9; border-color: #9ca3af; }
  body.light .badge { background: #f1f5f9; border-color: #cbd5e1; color: var(--text);}
  body.light .table th, body.light .table td { border-bottom-color: #e2e8f0; }
</style>
</head>
<body>
<header>
  <div class="brand" id="brand-title">꼬비아빠 놀이터</div>
  <div class="ver">
    <span id="data-timestamp">데이터 로딩중...</span>
    <div class="btn-group">
        <button id="mode-happy" class="btn" disabled>Happy</button>
        <button id="mode-nova" class="btn" disabled>Nova</button>
    </div>
  </div>
</header>

<div class="grid">
    <section class="card full-width">
        <h3>안내사항</h3>
        <p class="muted" style="margin: 0; font-size: 14px;">
          - 페트 데이터는 외부 파일에서 불러옵니다. 초기 로딩이 약간 걸릴 수 있습니다.<br>
          - 업데이트로 추가되는 페트와 기존 페트의 성장률 변경시 데이터가 다르게 나올 수 있습니다. <br>
          - 특이사항 : 꼬비 / 남아 / 푸들(갈색) / 20.03.24 출생 / 중성화 O
        </p>
    </section>

  <section class="card">
    <h3>① 페트 선택</h3>
    <div class="row">
      <div class="col chooser">
        <label>페트 초성</label>
        <div id="chosung" class="chips"></div>

        <div class="row" style="margin-top:6px; align-items:center">
          <span class="muted" style="min-width:78px">선택한 초성</span>
          <div id="chosungTokens" class="chips" style="min-height:28px"></div>
        </div>

        <div class="row" style="margin-top:8px">
          <div class="col">
            <input type="text" id="petSearch" placeholder="페트 이름으로 검색 (예: 꼬비)" />
          </div>
          <button class="btn" id="btnClear">지우기</button>
        </div>
        <div class="list" id="petList"></div>
      </div>
    </div>
    <p class="muted" style="margin-top:8px">팁 : 초성만 두세번 눌러도 검색이 가능합니다. (예: 꼬비 = <span class="kbd">ㄲ</span>→<span class="kbd">ㅂ</span>)</p>
  </section>

  <section class="card">
    <h3>② 능력치 확인 및 계산</h3>

    <div class="row">
      <div class="col">
        <label>S급 기준 초기치 (체/공/방/순)</label>
        <div class="row">
          <div class="col"><input type="number" id="s0_hp"  step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="s0_atk" step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="s0_def" step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="s0_agi" step="0.01" placeholder="—" readonly /></div>
        </div>

        <label style="margin-top:10px">S급 기준 성장률 (체/공/방/순)</label>
        <div class="row">
          <div class="col"><input type="number" id="sg_hp"  step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="sg_atk" step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="sg_def" step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="sg_agi" step="0.01" placeholder="—" readonly /></div>
        </div>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid #2a3040; margin:14px 0" />

    <div class="row">
      <div class="col">
        <label>내 페트 Lv 1 초기치 — 체/공/방/순</label>
        <div class="row">
          <div class="col">
            <input type="number" id="obs_hp"  step="1" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_hp" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_hp" data-delta="1">+1</button>
            </div>
          </div>
          <div class="col">
            <input type="number" id="obs_atk" step="1" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_atk" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_atk" data-delta="1">+1</button>
            </div>
          </div>
          <div class="col">
            <input type="number" id="obs_def" step="1" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_def" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_def" data-delta="1">+1</button>
            </div>
          </div>
          <div class="col">
            <input type="number" id="obs_agi" step="1" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_agi" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_agi" data-delta="1">+1</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnCalc">계산</button>
      <button class="btn ghost" id="btnReset">리셋</button>
      <span class="muted" style="margin-left:auto"> 클릭 후 마우스 휠로 Up/Down 가능</span>
    </div>
  </section>

  <section class="card full-width" id="resultCard">
    <h3>③ 결과 분석</h3>
    <div class="kpis">
        <div class="kpi">
          <div>
            <strong id="kpiSuccess">—%</strong>
            <small>환각(8등급) 확률</small>
          </div>
        </div>
        <div class="kpi">
          <div>
            <strong id="kpiAppear">—%</strong>
            <small>출현 확률</small>
          </div>
        </div>
        <div class="kpi">
          <div>
            <strong id="kpiTries">—</strong>
            <small>성공 기대값(시도)</small>
          </div>
        </div>
      </div>
    <div style="margin-top:14px">
      <div class="row">
        <div class="col"><span class="muted">총 경우의 수:</span> <span class="badge" id="totMatches">—</span></div>
        <div class="col"><span class="muted">환각 매칭:</span> <span class="badge" id="rank8Matches">—</span></div>
      </div>
    </div>
    <details style="margin-top:12px">
      <summary>등급 분포 자세히 보기</summary>
      <div id="dist"></div>
    </details>
  </section>
</div>

<div class="footer">
  <p> Data by. 꼬비아빠 </p>
</div>

<script>
// ▼▼▼ 1. Github에 올린 JSON 파일의 'Raw' 주소로 변경 ▼▼▼
const happyDataUrl = 'https://raw.githubusercontent.com/kkoby-daddy/sa_kkoby/main/data/happy_pets.json';
const novaDataUrl = 'https://raw.githubusercontent.com/kkoby-daddy/sa_kkoby/main/data/nova_pets.json';
// ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

/* ========= 페트 데이터 (외부 파일에서 로드) ========= */
let petData = {
    happy: { list: [] },
    nova: { list: [] }
};

/* ========= 상수 ========= */
const TOTAL = 178750;

/* ========= 전역 변수 ========= */
let GLOBAL_TABLE = {};
let ALL_NAMES = [];
let currentMode = '';

/* ========= 유틸리티 함수 ========= */
const fmtPct = (x) => {
  if(!Number.isFinite(x)) return "—%";
  if(x === 0) return "0.0000%";
  if(x < 0.001) return x.toFixed(6) + "%";
  return x.toFixed(4) + "%";
}

const CHO_CODE = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
const CHO_SIMPLE = (c)=>({"ㄲ":"ㄱ","ㄸ":"ㄷ","ㅃ":"ㅂ","ㅆ":"ㅅ","ㅉ":"ㅈ"}[c]||c);
const getChosung = (str) => {
  let out="";
  for(const ch of str){
    const code = ch.charCodeAt(0);
    if(code<0xAC00 || code>0xD7A3){ out+=ch; continue; }
    const idx = Math.floor((code - 0xAC00) / 588);
    out += CHO_SIMPLE(CHO_CODE[idx]);
  }
  return out;
}

/* ========= 데이터 처리 함수 ========= */
const getRank = (p) => {
    if (p.rank) return p.rank;
    const totalStats = p.hp + p.atk + p.def + p.agi;
    if (totalStats >= 110) return 435;
    if (totalStats >= 105) return 455;
    if (totalStats >= 100) return 475;
    if (totalStats >= 95) return 495;
    if (totalStats >= 90) return 515;
    if (totalStats >= 85) return 535;
    if (totalStats >= 80) return 555;
    return 575;
}

const calculateS0 = (k, u) => {
    const preciseRound = (num) => Math.round(num * 1e12) / 1e12;
    const fac = k / 100;
    const vhp  = (u.hp + 4.5) * fac;
    const vatk = (u.atk+ 4.5) * fac;
    const vdef = (u.def+ 4.5) * fac;
    const vagi = (u.agi+ 4.5) * fac;

    const hp = preciseRound(vhp), atk = preciseRound(vatk), def = preciseRound(vdef), agi = preciseRound(vagi);

    return {
        hp: preciseRound((hp * 4) + atk + def + agi),
        atk: preciseRound((hp * 0.1) + atk + (def * 0.1) + (agi * 0.05)),
        def: preciseRound((hp * 0.1) + (atk * 0.1) + def + (agi * 0.05)),
        agi: preciseRound(agi)
    };
}

const calculateSg = (u, e) => {
    const preciseRound = (num) => Math.round(num * 1e12) / 1e12;
    const f = e / 10000;
    const u_hp = u.hp + 4.5, u_atk = u.atk + 4.5, u_def = u.def + 4.5, u_agi = u.agi + 4.5;

    const upHp = u_hp * f, upAtk = u_atk * f, upDef = u_def * f, upAgi = u_agi * f;

    return {
        hp:  preciseRound((upHp * 4) + upAtk + upDef + upAgi),
        atk: preciseRound((upHp * 0.1) + upAtk + (upDef * 0.1) + (upAgi * 0.05)),
        def: preciseRound((upHp * 0.1) + (upAtk * 0.1) + upDef + (upAgi * 0.05)),
        agi: preciseRound(upAgi)
    };
}

const buildPetTable = () => {
    GLOBAL_TABLE = {};
    const sourceList = petData[currentMode]?.list || [];
    if (!Array.isArray(sourceList) || sourceList.length === 0) {
        console.warn(`${currentMode} 모드의 페트 리스트가 비어있거나 배열이 아닙니다.`);
        ALL_NAMES = [];
        return;
    }
    for (const p of sourceList) {
        if (!p || typeof p.name === 'undefined' || typeof p.hp !== 'number') {
            console.warn("잘못된 형식의 페트 데이터 발견:", p);
            continue;
        }
        try {
            const u = { hp: p.hp, atk: p.atk, def: p.def, agi: p.agi };
            const k = p.initnum;
            const e = getRank(p);
            GLOBAL_TABLE[p.name] = { k, u, s0: calculateS0(k, u), sg: calculateSg(u, e) };
        } catch(calcError) {
            console.error(`페트 ${p.name} 계산 중 오류:`, calcError, p);
        }
    }
    ALL_NAMES = Object.keys(GLOBAL_TABLE).sort((a,b)=>a.localeCompare(b,'ko'));
    console.log(`${currentMode} 모드 테이블 빌드 완료 (${ALL_NAMES.length}개)`);
}


/* ========= DOM 요소 캐싱 ========= */
const brandTitle = document.getElementById('brand-title');
const dataTimestamp = document.getElementById('data-timestamp');
const chosungBar = document.getElementById('chosung');
const chosungTokens = document.getElementById('chosungTokens');
const petList = document.getElementById('petList');
const petSearch = document.getElementById('petSearch');
const s0hp = document.getElementById('s0_hp'), s0atk= document.getElementById('s0_atk'), s0def= document.getElementById('s0_def'), s0agi= document.getElementById('s0_agi');
const sghp = document.getElementById('sg_hp'), sgatk= document.getElementById('sg_atk'), sgdef= document.getElementById('sg_def'), sgagi= document.getElementById('sg_agi');
const obshp = document.getElementById('obs_hp'), obsatk= document.getElementById('obs_atk'), obsdef= document.getElementById('obs_def'), obsagi= document.getElementById('obs_agi');
const kpiSuccess = document.getElementById('kpiSuccess'), kpiAppear  = document.getElementById('kpiAppear'), kpiTries = document.getElementById('kpiTries');
const totMatches = document.getElementById('totMatches'), rank8Matches = document.getElementById('rank8Matches');
const distBox = document.getElementById('dist');
const btnCalc = document.getElementById('btnCalc'), btnReset= document.getElementById('btnReset'), btnClear= document.getElementById('btnClear');
const btnModeHappy = document.getElementById('mode-happy');
const btnModeNova = document.getElementById('mode-nova');

let currentChosung="", selectedName=null, selectedRow=null, selectedItemEl=null;

/* ========= UI 렌더링 함수 ========= */
const renderChosungTokens = () => {
  chosungTokens.innerHTML = "";
  for(const ch of currentChosung){
    const t = document.createElement('div');
    t.className = 'chip'; t.style.cursor = 'default'; t.textContent = ch;
    chosungTokens.appendChild(t);
  }
}

const renderPetList = () => {
  const kw = (petSearch.value||"").trim();
  const list = ALL_NAMES.filter(n => (kw? n.includes(kw): true) && (currentChosung? getChosung(n).startsWith(currentChosung): true));

  petList.innerHTML="";
  if(list.length===0){
    const d=document.createElement('div'); d.className='item';
    d.textContent='결과 없음 (또는 데이터 로딩 중...)';
    petList.appendChild(d); return;
  }

  list.forEach(n=>{
    const div=document.createElement('div'); div.className='item';
    const left=document.createElement('div'); left.textContent = n;
    const right=document.createElement('div'); right.className="tags";
    const tag1=document.createElement('span');
    tag1.className = 'tag ok';
    tag1.textContent = '등록됨';
    right.appendChild(tag1);

    div.appendChild(left);
    div.appendChild(right);

    div.addEventListener('click', ()=>{
      if(selectedItemEl) selectedItemEl.classList.remove('selected');
      div.classList.add('selected');
      selectedItemEl = div;
      selectPetName(n);
    });
    if (n === selectedName) { div.classList.add('selected'); selectedItemEl = div; }
    petList.appendChild(div);
  });
  renderChosungTokens();
}

const showKpis = (res) => {
  if(!res){
    kpiSuccess.textContent = "—%";
    kpiAppear.textContent = "—%";
    kpiTries.textContent = "—";
    totMatches.textContent = "—";
    rank8Matches.textContent = "—";
    distBox.innerHTML = "";
    return;
  }

  const matches = res.matches|0;
  const rank8   = res.rank8|0;
  const appear  = matches/TOTAL*100;
  const successPct = matches ? (rank8/matches*100) : 0;
  const tries = successPct > 0 ? (100/successPct) : Infinity;

  kpiSuccess.textContent = fmtPct(successPct);
  kpiAppear.textContent = fmtPct(appear);
  kpiTries.textContent = (isFinite(tries) ? tries.toFixed(2) : "—");
  totMatches.textContent   = matches.toLocaleString();
  rank8Matches.textContent = rank8.toLocaleString();

  const entries = Object.entries(res.dist)
    .map(([r,c]) => ({r:parseInt(r,10), c}))
    .sort((a,b) => b.r - a.r || b.c - a.c);

  let html = `<table class="table"><thead><tr><th>등급(베이스합)</th><th>건수</th><th>비율</th></tr></thead><tbody>`;
  const total = matches || 1;
  entries.forEach(e=>{
    const pct = (e.c/total*100).toFixed(2);
    const cls = (e.r===8 ? "ok" : (e.r>=5 ? "warn" : ""));
    html += `<tr><td class="${cls}">${e.r}</td><td>${e.c.toLocaleString()}</td><td>${pct}%</td></tr>`;
  });
  html += `</tbody></table>`;
  distBox.innerHTML = html;
}

/* ========= 코어 계산 엔진 ========= */
const enumerate_kkoby = (pku, obs) => {
  Decimal.set({ precision: 50, rounding: Decimal.ROUND_HALF_UP });
  const k = new Decimal(pku.k);
  const fac = k.dividedBy(100);
  const u = pku.u;
  let matches = 0, rank8 = 0;
  const dist = {};
  const baseCnt = 5, baseInit = -2;

  for(let hr=baseInit; hr<baseInit+baseCnt; hr++){
  for(let ar=baseInit; ar<baseInit+baseCnt; ar++){
  for(let dr=baseInit; dr<baseInit+baseCnt; dr++){
  for(let gr=baseInit; gr<baseInit+baseCnt; gr++){
  for(let hb=0; hb<=10; hb++){
  for(let ab=0; ab<=10; ab++){
  for(let db=0; db<=10; db++){
    const gb = 10 - hb - ab - db;
    if(gb < 0 || gb > 10) continue;

    const baseH = new Decimal(u.hp + hr + hb);
    const baseA = new Decimal(u.atk + ar + ab);
    const baseD = new Decimal(u.def + dr + db);
    const baseG = new Decimal(u.agi + gr + gb);

    const iH = baseH.times(fac), iA = baseA.times(fac), iD = baseD.times(fac), iG = baseG.times(fac);
    const preciseRound = (num) => num.toDP(12, Decimal.ROUND_HALF_UP);

    const r_hp = preciseRound(iH), r_atk = preciseRound(iA), r_def = preciseRound(iD), r_agi = preciseRound(iG);

    const calcHp  = preciseRound(r_hp.times(4).plus(r_atk).plus(r_def).plus(r_agi)).floor().toNumber();
    const calcAtk = preciseRound(r_hp.times('0.1').plus(r_atk).plus(r_def.times('0.1')).plus(r_agi.times('0.05'))).floor().toNumber();
    const calcDef = preciseRound(r_hp.times('0.1').plus(r_atk.times('0.1')).plus(r_def).plus(r_agi.times('0.05'))).floor().toNumber();
    const calcAgi = preciseRound(r_agi).floor().toNumber();

    if(calcHp===obs[0] && calcAtk===obs[1] && calcDef===obs[2] && calcAgi===obs[3]){
      matches++;
      const r = hr + ar + dr + gr;
      dist[r] = (dist[r]||0) + 1;
      if(r === 8) rank8++;
    }
  }}}}}}}}
  Decimal.set({ precision: 20 });
  return {matches, rank8, dist};
}

/* ========= 이벤트 핸들러 및 상태 관리 ========= */
const selectPetName = (n) => {
  selectedName=n;
  selectedRow=GLOBAL_TABLE[n]||null;

  if(selectedRow?.s0){
    s0hp.value=selectedRow.s0.hp.toFixed(2); s0atk.value=selectedRow.s0.atk.toFixed(2);
    s0def.value=selectedRow.s0.def.toFixed(2); s0agi.value=selectedRow.s0.agi.toFixed(2);
  } else { s0hp.value=s0atk.value=s0def.value=s0agi.value=""; }

  if(selectedRow?.sg){
    sghp.value=selectedRow.sg.hp.toFixed(2); sgatk.value=selectedRow.sg.atk.toFixed(2);
    sgdef.value=selectedRow.sg.def.toFixed(2); sgagi.value=selectedRow.sg.agi.toFixed(2);
  } else { sghp.value=sgatk.value=sgdef.value=sgagi.value=""; }

  if(selectedRow?.s0){
    obshp.value = Math.floor(selectedRow.s0.hp)||"";
    obsatk.value= Math.floor(selectedRow.s0.atk)||"";
    obsdef.value= Math.floor(selectedRow.s0.def)||"";
    obsagi.value= Math.floor(selectedRow.s0.agi)||"";
  } else { obshp.value=obsatk.value=obsdef.value=obsagi.value=""; }
  showKpis(null);
}

const resetAll = () => {
    selectedName=null; selectedRow=null;
    petSearch.value=""; currentChosung="";
    Array.from(chosungBar.children).forEach(el=>el.classList.remove('on'));
    if (selectedItemEl) {
        selectedItemEl.classList.remove('selected');
        selectedItemEl = null;
    }
    renderChosungTokens();
    renderPetList();
    [s0hp,s0atk,s0def,s0agi,sghp,sgatk,sgdef,sgagi,obshp,obsatk,obsdef,obsagi].forEach(i=>i.value="");
    showKpis(null);
}

// ▼▼▼ 2. switchMode 함수 전체 수정 ▼▼▼
async function switchMode(mode) {
    if (currentMode === mode && petData[mode].list.length > 0) return;

    // 로딩 시작 UI
    btnModeHappy.disabled = true;
    btnModeNova.disabled = true;
    const modeName = mode.charAt(0).toUpperCase() + mode.slice(1);
    brandTitle.textContent = `${modeName} 데이터 로딩 중...`;
    dataTimestamp.textContent = "";

    currentMode = mode;
    const dataUrl = (mode === 'happy') ? happyDataUrl : novaDataUrl;

    try {
        // fetch를 사용하여 JSON 파일 비동기 로드
        const response = await fetch(dataUrl + `?v=${Date.now()}`); // 캐시 방지를 위해 현재 시간 추가
        if (!response.ok) {
            throw new Error(`HTTP 오류! 상태: ${response.status}. 파일(${dataUrl})을 찾을 수 없습니다.`);
        }
        const petList = await response.json();

        if (!Array.isArray(petList)) {
             throw new Error(`로드된 데이터(${dataUrl})가 올바른 JSON 배열 형식이 아닙니다.`);
        }

        petData[currentMode].list = petList;
        console.log(`${mode} 데이터 로드 성공! (${petList.length}개)`);

        buildPetTable(); // 데이터 로드 완료 후 테이블 빌드

        // UI 업데이트
        if (mode === 'happy') {
            document.body.classList.remove('light');
            brandTitle.textContent = "꼬비아빠 놀이터 (Happy)";
            dataTimestamp.textContent = 'Happy 서버 데이터';
            btnModeHappy.classList.add('active');
            btnModeNova.classList.remove('active');
        } else { // nova
            document.body.classList.add('light');
            brandTitle.textContent = "꼬비아빠 놀이터 (Nova)";
            dataTimestamp.textContent = 'Nova 서버 데이터';
            btnModeNova.classList.add('active');
            btnModeHappy.classList.remove('active');
        }

        resetAll();

    } catch (error) {
        console.error(`페트 데이터 (${mode}) 로딩 실패:`, error);
        alert(`${mode} 페트 데이터를 불러오는 중 오류가 발생했습니다: ${error.message}`);
        brandTitle.textContent = `${modeName} 데이터 로드 오류`;
        petData[currentMode] = { list: [] };
        buildPetTable();
        resetAll();
    } finally {
        // 로딩 완료 후 버튼 활성화
        btnModeHappy.disabled = false;
        btnModeNova.disabled = false;
    }
}
// ▲▲▲▲▲ switchMode 함수 전체 수정 ▲▲▲▲▲

/* ========= 이벤트 리스너 바인딩 ========= */
btnCalc.addEventListener('click', ()=>{
  if(!selectedName){ alert("펫을 먼저 선택하세요."); return; }
  const obs=[obshp,obsatk,obsdef,obsagi].map(e=>parseInt(e.value,10));
  if(obs.some(v=>!Number.isFinite(v))){ alert("내 페트 Lv 1 초기치를 모두 입력하세요."); return; }
  const row=GLOBAL_TABLE[selectedName]||{};
  if(!row?.k || !row?.u){ alert("선택된 펫의 데이터(k/u)가 올바르지 않습니다."); return; }
  showKpis(enumerate_kkoby({k: row.k, u: row.u}, obs));
});

btnReset.addEventListener('click', resetAll);
btnClear.addEventListener('click', ()=>{
  petSearch.value=""; currentChosung="";
  Array.from(chosungBar.children).forEach(el=>el.classList.remove('on'));
  if (selectedItemEl) { selectedItemEl.classList.remove('selected'); selectedItemEl = null; }
  renderChosungTokens();
  renderPetList();
});

btnModeHappy.addEventListener('click', () => switchMode('happy'));
btnModeNova.addEventListener('click', () => switchMode('nova'));

document.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-delta][data-target]'); if(!btn) return;
  const id = btn.getAttribute('data-target'); const delta = parseInt(btn.getAttribute('data-delta'),10);
  const input=document.getElementById(id); if(!input) return;
  const curr=parseInt(input.value||"0",10);
  input.value = String(isNaN(curr) ? delta : curr + delta);
});
['wheel'].forEach(evt => {
    document.addEventListener(evt, e => {
        const input = e.target;
        if (input.tagName === 'INPUT' && input.type === 'number' && document.activeElement === input) {
            e.preventDefault();
            const delta = (e.deltaY || e.detail || e.wheelDelta) < 0 ? 1 : -1;
            const curr=parseInt(input.value||"0",10);
            input.value = String(isNaN(curr) ? delta : curr + delta);
        }
    }, {passive:false});
});


/* ========= 애플리케이션 초기화 ========= */
// ▼▼▼ 3. init 함수를 async로 변경하고 await 추가 ▼▼▼
(async function init(){
  CHO.forEach(c=>{
      const chip=document.createElement('div');
      chip.className='chip'; chip.textContent=c;
      chip.addEventListener('click', ()=>{
        currentChosung += c;
        renderPetList();
        renderChosungTokens();
      });
      chosungBar.appendChild(chip);
  });
  await switchMode('happy'); // 페이지 로딩 시 happy 모드 데이터를 불러올 때까지 기다립니다.
})();
// ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲
</script>
</body>
</html>
