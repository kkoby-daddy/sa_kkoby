<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>꼬비아빠 놀이터</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
<style>
  /* 바디 레벨 플로팅 툴팁 */
  .floating-tip{
    position: fixed; z-index: 9999; max-width: 360px;
    background:#0b1320; color:#cfe1ff; border:1px solid #2b3a55;
    border-radius:10px; padding:8px 10px; font-size:12px; line-height:1.35;
    box-shadow:0 8px 24px rgba(0,0,0,.35);
    pointer-events:none; white-space:normal; word-break:keep-all;
    opacity:0; transform: translateY(4px);
    transition: opacity .12s ease, transform .12s ease;
  }
  .floating-tip.show{ opacity:1; transform: translateY(0); }
  .floating-tip::after{
    content:""; position:absolute; width:10px; height:10px; left:50%;
    transform: translateX(-50%) rotate(45deg);
    background:#0b1320; border-left:1px solid #2b3a55; border-top:1px solid #2b3a55;
  }
  .floating-tip[data-pos="top"]::after{ bottom:-5px; }
  .floating-tip[data-pos="bottom"]::after{ top:-5px; transform: translateX(-50%) rotate(225deg); }

  :root{
    --bg:#0f1115; --panel:#161a22; --muted:#8a9099; --accent:#6aa0ff;
    --ok:#35c759; --warn:#ffb300; --bad:#ff5171; --chip:#232a36;
    --ring:#1f2530; --text:#e8ecf3; --highlight:#fff;
    --ring-size: 60px; --ring-thickness: 6px; --hud-speed: 120;
    --glow: 8px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:var(--bg); color:var(--text);
    transition: background-color .3s ease, color .3s ease;
  }
  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:16px 20px; border-bottom:1px solid #232a36; background:rgba(0,0,0,.2);
    position:sticky; top:0; z-index:10;
  }
  .brand{font-weight:700; letter-spacing:.3px}
  .ver{color:var(--muted); font-size:12px; display:flex; align-items:center; gap:10px}
  .grid{ max-width:1300px; margin:20px auto; padding:0 16px; display:grid; gap:16px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--panel); border:1px solid #232a36; border-radius:14px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.25);}
  .full-width { grid-column: 1 / -1; }
  .card h3{margin:4px 0 12px 0; font-size:16px}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  .col{flex:1 1 0}
  label{display:block; font-size:12px; color:var(--muted); margin:6px 0 4px 2px}
  input[type="number"], input[type="text"]{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3040;
    background:#0e1218; color:var(--text); outline:none;
  }
  input[readonly]{opacity:.7; cursor:not-allowed}
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  .btn{ padding:10px 14px; border-radius:10px; border:1px solid #334055; cursor:pointer; background:#142033; color:#cfe1ff; font-weight:600; }
  .btn:hover{filter:brightness(1.1)}
  .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: none; } /* 비활성화 스타일 */
  .btn.primary{ background:linear-gradient(180deg,#2b71ff,#1d56cc); border-color:transparent; color:white;}
  .btn.ghost{ background:transparent;}
  .btn-sm{padding:6px 10px; font-size:12px; border-radius:8px}
  .btn-group {display: flex;}
  .btn-group .btn{ border-radius: 0; margin-left: -1px; }
  .btn-group .btn:first-child{ border-top-left-radius: 10px; border-bottom-left-radius: 10px; margin-left: 0;}
  .btn-group .btn:last-child{ border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
  .btn-group .btn.active{ background:linear-gradient(180deg,#2b71ff,#1d56cc); border-color:transparent; color:white; filter: none; }
  .muted{color:var(--muted)}
  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{ background:var(--chip); color:#cfd6e3; border:1px solid #2b3242; border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer; }
  .chip.on{outline:2px solid var(--accent)}
  .kbd{display:inline-block; border:1px solid #404a5e; border-bottom-width:3px; padding:2px 6px; border-radius:6px; background:#0e131a; font-weight:700}
  .chooser{display:grid; grid-template-columns: 1fr; gap:8px}
  .list{ max-height:260px; overflow:auto; border:1px solid #2a3040; border-radius:10px; padding:6px; background:#0d1117; }
  .item{padding:8px 10px; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition: background .12s ease, outline-color .12s ease; }
  .item:hover{background:#19202b}
  .item.selected{ background:#1b2535; outline:2px solid #30518d; }
  .tags{display:flex; gap:6px; align-items:center}
  .tag{font-size:11px;border:1px solid #2b3242;border-radius:999px;padding:2px 8px}
  .tag.ok{border-color:#275a34; background:#102214; color:#35c759}
  .tag.warn{border-color:#7a5b0e; background:#241a05; color:#ffb300}
  .tag.rank8{border-color:#2b4a82; background:#0d1a33; color:#88b5ff}
  .tag.tip { cursor: help; } /* 툴팁 표시용 */
  .kpis{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px}
  @media (max-width: 720px){ .kpis{grid-template-columns: 1fr} }
  .kpi{ display:flex; gap:14px; align-items:center; border:1px solid #2a3040; border-radius:14px; padding:14px; background:radial-gradient(120px 120px at 20% -10%, #11224444, transparent); }

  /* --- SVG Ring Styles --- */
  .ringwrap{ position:relative; width:var(--ring-size); height:var(--ring-size); flex:0 0 var(--ring-size); }
  svg{ display:block; width:100%; height:100%; }
  .track{ stroke: var(--ring); fill:none; stroke-linecap: round; }
  .fill { stroke: var(--accent); fill:none; stroke-linecap: round; transition: stroke .25s ease, stroke-dashoffset .25s linear; }

  /* --- HUD Styles --- */
  .hud { filter: drop-shadow(0 0 var(--glow) rgba(160,200,255,.6)); }
  .tail{ stroke: #9fc3ff; stroke-linecap: round; opacity:.7; fill:none; }
  .core{ stroke: #fff;     stroke-linecap: round; fill:none; }
  .flare{ fill: #fff; opacity:.95; }

  #kpiSuccess, #kpiAppear, #kpiTries {
    display:inline-block;
    min-width: 9ch;
    font-variant-numeric: tabular-nums;
  }
  #kpiTries { min-width: 6ch; }

  .kpi strong{font-size:20px; color:var(--highlight)}
  .kpi small{display:block; color:var(--muted)}
  .table{width:100%; border-collapse:collapse; font-size:13px}
  .table th,.table td{border-bottom:1px solid #262d3a; padding:8px 6px; text-align:right}
  .table th:first-child,.table td:first-child{text-align:left}
  .badge{display:inline-block; min-width:34px; text-align:center; padding:2px 6px; border-radius:6px; background:#223; border:1px solid #356}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .footer{max-width:1100px; margin:8px auto 30px; padding:0 16px; color:var(--muted); font-size:12px; text-align: center;}
  .stepper{display:flex; gap:6px; margin-top:6px}

  /* --- Transitions --- */
  body, .card, header, input, .btn, .chip, .list, .item, .badge, .table th, .table td, hr {
    transition: background-color .3s ease, color .3s ease, border-color .3s ease;
  }

  /* --- Light Mode --- */
  body.light {
    --bg: #e2e8f0; --panel: #ffffff; --muted: #64748b; --accent: #2563eb;
    --ok: #16a34a; --warn: #f59e0b; --bad: #dc2626; --chip: #f1f5f9;
    --ring: #cbd5e1; --text: #1e293b; --highlight: #000000;
  }
  body.light header{ background: rgba(255,255,255,0.7); backdrop-filter: blur(8px); border-color: #d1d5db; }
  body.light .card { border-color: #d1d5db; box-shadow: 0 6px 24px rgba(0,0,0,.07); }
  body.light hr { border-top-color: #e2e8f0; }
  body.light input[type="number"], body.light input[type="text"], body.light .list { background: #f8fafc; border-color: #cbd5e1; }
  body.light .item:hover{background:#f1f5f9}
  body.light .item.selected{ background:#e2e8f0; outline-color:#9ca3af; }
  body.light .btn{ background:#f1f5f9; border-color:#cbd5e1; color: var(--text); }
  body.light .btn:hover{filter:brightness(.98)}
  body.light .btn.primary, body.light .btn-group .btn.active { background:linear-gradient(180deg,#2563eb,#1d4ed8); border-color:transparent; color:white; }
  body.light .chip{ background:#f8fafc; border-color:#cbd5e1; }
  body.light .kbd { background: #f1f5f9; border-color: #9ca3af; }
  body.light .badge { background: #f1f5f9; border-color: #cbd5e1; color: var(--text);}
  body.light .floating-tip, body.light .floating-tip::after { background: #fff; color: #1f2937; border-color: #d1d5db;}
  body.light .table th, body.light .table td { border-bottom-color: #e2e8f0; }

</style>
</head>
<body>
<div class="floating-tip"></div> <header>
  <div class="brand" id="brand-title">꼬비아빠 놀이터</div>
  <div class="ver">
    <span id="data-timestamp">데이터 로딩중...</span>
    <div class="btn-group">
        <button id="mode-happy" class="btn" disabled>Happy</button>
        <button id="mode-nova" class="btn" disabled>Nova</button>
    </div>
  </div>
</header>

<div class="grid">
    <section class="card full-width">
        <h3>안내사항</h3>
        <p class="muted" style="margin: 0; font-size: 14px;">
          - 입력된 페트 능력치에는 오타가 있을 수 있으니 페트 조회 시 게임 내 페트의 초기치 및 성장률이 같은지 확인하세요. <br>
          - 업데이트로 추가되는 페트와 기존 페트의 성장률 변경시 데이터가 다르게 나올 수 있습니다. <br>
          - 특이사항 : 꼬비 / 남아 / 푸들(갈색) / 20.03.24 출생 / 중성화 O
        </p>
    </section>

  <section class="card">
    <h3>① 페트 선택</h3>
    <div class="row">
      <div class="col chooser">
        <label>페트 초성</label>
        <div id="chosung" class="chips"></div>

        <div class="row" style="margin-top:6px; align-items:center">
          <span class="muted" style="min-width:78px">선택한 초성</span>
          <div id="chosungTokens" class="chips" style="min-height:28px"></div>
        </div>

        <div class="row" style="margin-top:8px">
          <div class="col">
            <input type="text" id="petSearch" placeholder="페트 이름으로 검색 (예: 꼬비)" />
          </div>
          <button class="btn" id="btnClear">지우기</button>
        </div>
        <div class="list" id="petList"></div>
      </div>
    </div>
    <p class="muted" style="margin-top:8px">팁 : 초성만 두세번 눌러도 검색이 가능합니다. (예: 꼬비 = <span class="kbd">ㄲ</span>→<span class="kbd">ㅂ</span>)</p>
  </section>

  <section class="card">
    <h3>② 능력치 확인 및 계산</h3>

    <div class="row">
      <div class="col">
        <label>S급 기준 초기치 (체/공/방/순)</label>
        <div class="row">
          <div class="col"><input type="number" id="s0_hp"  step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="s0_atk" step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="s0_def" step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="s0_agi" step="0.01" placeholder="—" readonly /></div>
        </div>

        <label style="margin-top:10px">S급 기준 성장률 (체/공/방/순)</label>
        <div class="row">
          <div class="col"><input type="number" id="sg_hp"  step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="sg_atk" step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="sg_def" step="0.01" placeholder="—" readonly /></div>
          <div class="col"><input type="number" id="sg_agi" step="0.01" placeholder="—" readonly /></div>
        </div>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid #2a3040; margin:14px 0" />

    <div class="row">
      <div class="col">
        <label>내 페트 Lv 1 초기치 — 체/공/방/순</label>
        <div class="row">
          <div class="col">
            <input type="number" id="obs_hp"  step="1" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_hp" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_hp" data-delta="1">+1</button>
            </div>
          </div>
          <div class="col">
            <input type="number" id="obs_atk" step="1" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_atk" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_atk" data-delta="1">+1</button>
            </div>
          </div>
          <div class="col">
            <input type="number" id="obs_def" step="1" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_def" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_def" data-delta="1">+1</button>
            </div>
          </div>
          <div class="col">
            <input type="number" id="obs_agi" step="1" />
            <div class="stepper">
              <button class="btn btn-sm" data-target="obs_agi" data-delta="-1">-1</button>
              <button class="btn btn-sm" data-target="obs_agi" data-delta="1">+1</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="btnCalc">계산</button>
      <button class="btn ghost" id="btnReset">리셋</button>
      <span class="muted" style="margin-left:auto"> 클릭 후 마우스 휠로 Up/Down 가능</span>
    </div>
  </section>

  <section class="card full-width" id="resultCard">
    <h3>③ 결과 분석</h3>
    <div class="kpis">
        <div class="kpi">
          <div class="ringwrap">
            <svg viewBox="0 0 100 100" aria-hidden="true">
              <defs>
                <circle id="succPath" cx="50" cy="50" r="45"/>
                <mask id="succMask" maskUnits="userSpaceOnUse">
                  <circle id="succMaskStroke" cx="50" cy="50" r="45"
                          fill="none" stroke="#fff" stroke-width="10" stroke-linecap="round"
                          transform="rotate(-90 50 50)"
                          stroke-dasharray="0 1" stroke-dashoffset="0"/>
                </mask>
              </defs>

              <use href="#succPath" class="track" stroke-width="10" transform="rotate(-90 50 50)"/>
              <use id="succFill" href="#succPath" class="fill" stroke-width="10"
                   transform="rotate(-90 50 50)" stroke-dasharray="0 1" stroke-dashoffset="0"/>

              <g id="succHUD" class="hud" mask="url(#succMask)">
                <path id="succTail" class="tail" stroke-width="10"/>
                <path id="succCore" class="core" stroke-width="6"/>
                <circle id="succFlare" class="flare" r="3" cx="50" cy="5"/>
              </g>
            </svg>
          </div>
          <div>
            <strong id="kpiSuccess">—%</strong>
            <small>환각(8등급) 확률</small>
          </div>
        </div>

        <div class="kpi">
          <div class="ringwrap">
            <svg viewBox="0 0 100 100" aria-hidden="true">
              <circle id="apPath" cx="50" cy="50" r="43" fill="none"/>
              <use href="#apPath" class="track" stroke-width="10" transform="rotate(-90 50 50)"/>
              <use id="apFill"  href="#apPath" class="fill"  stroke="#7fd4ff" stroke-width="10"
                   transform="rotate(-90 50 50)" stroke-dasharray="0 1" stroke-dashoffset="0"/>
            </svg>
          </div>
          <div>
            <strong id="kpiAppear">—%</strong>
            <span id="apBadge" class="badge" style="display:none">max 2%</span>
            <small>출현 확률</small>
          </div>
        </div>

        <div class="kpi">
          <div class="ringwrap">
            <svg viewBox="0 0 100 100" aria-hidden="true">
              <circle id="trPath" cx="50" cy="50" r="43" fill="none"/>
              <use href="#trPath" class="track" stroke-width="10" transform="rotate(-90 50 50)"/>
              <use id="trFill"  href="#trPath" class="fill" stroke="#999" stroke-width="10"
                   transform="rotate(-90 50 50)" stroke-dasharray="0 1" stroke-dashoffset="0"/>
            </svg>
          </div>
          <div>
            <strong id="kpiTries">—</strong>
            <small>성공 기대값(시도)</small>
          </div>
        </div>
      </div>
    <div style="margin-top:14px">
      <div class="row">
        <div class="col"><span class="muted">총 경우의 수:</span> <span class="badge" id="totMatches">—</span></div>
        <div class="col"><span class="muted">환각 매칭:</span> <span class="badge" id="rank8Matches">—</span></div>
      </div>
    </div>
    <details style="margin-top:12px">
      <summary>등급 분포 자세히 보기</summary>
      <div id="dist"></div>
    </details>
  </section>
  </div>

<div class="footer">
  <p> Data by. 꼬비아빠 </p>
</div>

<script>
/* ========= 페트 데이터 (외부 파일에서 로드) ========= */
let petData = {
    happy: { timestamp: "", list: [] }, // 초기 빈 데이터 구조
    nova: { timestamp: "", list: [] }
};
// ▼▼▼▼▼ 파일 경로 수정 ▼▼▼▼▼
const happyDataUrl = './data/happy_pets.json'; // data 폴더 안의 파일 지정
const novaDataUrl = './data/nova_pets.json';   // data 폴더 안의 파일 지정
// ▲▲▲▲▲ 파일 경로 수정 ▲▲▲▲▲

/* ========= 상수 ========= */
const TOTAL = 178750;

/* ========= 전역 ========= */
let GLOBAL_TABLE = {};
let ALL_NAMES = [];
let currentMode = '';

/* ========= 유틸 ========= */
function fmtPct(x){
  if(!Number.isFinite(x)) return "—%";
  if(x === 0) return "0.0000%";
  if(x < 0.001) return x.toFixed(6) + "%";
  return x.toFixed(4) + "%";
}

/* ========= 초성(문자 → 초성) 유틸 ========= */
const CHO_CODE = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
const CHO_SIMPLE = (c)=>({"ㄲ":"ㄱ","ㄸ":"ㄷ","ㅃ":"ㅂ","ㅆ":"ㅅ","ㅉ":"ㅈ"}[c]||c);
function getChosung(str){
  let out="";
  for(const ch of str){
    const code = ch.charCodeAt(0);
    if(code<0xAC00 || code>0xD7A3){ out+=ch; continue; }
    const idx = Math.floor((code - 0xAC00) / 588);
    out += CHO_SIMPLE(CHO_CODE[idx]);
  }
  return out;
}

/* ========= 데이터 변환 및 로드 ========= */
function getRank(p) {
    if (p.rank) return p.rank;
    const totalStats = p.hp + p.atk + p.def + p.agi;
    if (totalStats >= 110) return 435;
    if (totalStats >= 105) return 455;
    if (totalStats >= 100) return 475;
    if (totalStats >= 95) return 495;
    if (totalStats >= 90) return 515;
    if (totalStats >= 85) return 535;
    if (totalStats >= 80) return 555;
    return 575;
}

function calculateS0(k, u) {
    const preciseRound = (num) => Math.round(num * 1e12) / 1e12;
    const fac = k / 100;
    const vhp  = preciseRound((u.hp + 4.5) * fac);
    const vatk = preciseRound((u.atk+ 4.5) * fac);
    const vdef = preciseRound((u.def+ 4.5) * fac);
    const vagi = preciseRound((u.agi+ 4.5) * fac);

    return {
        hp: preciseRound((vhp * 4) + vatk + vdef + vagi),
        atk: preciseRound((vhp * 0.1) + vatk + (vdef * 0.1) + (vagi * 0.05)),
        def: preciseRound((vhp * 0.1) + (vatk * 0.1) + vdef + (vagi * 0.05)),
        agi: preciseRound(vagi)
    };
}

function calculateSg(u, e) {
    const preciseRound = (num) => Math.round(num * 1e12) / 1e12;
    const f = e / 10000;
    const u_hp = u.hp + 4.5;
    const u_atk = u.atk + 4.5;
    const u_def = u.def + 4.5;
    const u_agi = u.agi + 4.5;

    const upHp  = preciseRound(u_hp  * f);
    const upAtk = preciseRound(u_atk * f);
    const upDef = preciseRound(u_def * f);
    const upAgi = preciseRound(u_agi * f);

    return {
        hp:  preciseRound((upHp * 4) + upAtk + upDef + upAgi),
        atk: preciseRound((upHp * 0.1) + upAtk + (upDef * 0.1) + (upAgi * 0.05)),
        def: preciseRound((upHp * 0.1) + (upAtk * 0.1) + upDef + (upAgi * 0.05)),
        agi: preciseRound(upAgi)
    };
}

// ▼▼▼▼▼ buildPetTable 수정: 오류 처리 강화 ▼▼▼▼▼
function buildPetTable() {
    GLOBAL_TABLE = {};
    const sourceList = petData[currentMode]?.list || [];
    if (!Array.isArray(sourceList) || sourceList.length === 0) { // 배열 확인 추가
        console.warn(`${currentMode} 모드의 페트 리스트가 비어있거나 배열이 아닙니다.`);
        ALL_NAMES = [];
        return;
    }
    for (const p of sourceList) {
        // 데이터 유효성 검사 추가
        if (!p || typeof p.name === 'undefined' || typeof p.hp !== 'number' || typeof p.atk !== 'number' || typeof p.def !== 'number' || typeof p.agi !== 'number' || typeof p.initnum !== 'number') {
            console.warn("잘못된 형식의 페트 데이터 발견:", p);
            continue; // 유효하지 않은 데이터 건너뛰기
        }
        try { // 계산 중 오류 발생 대비
            const u = { hp: p.hp, atk: p.atk, def: p.def, agi: p.agi };
            const k = p.initnum;
            const e = getRank(p);
            const s0 = calculateS0(k, u);
            const sg = calculateSg(u, e);
            GLOBAL_TABLE[p.name] = { k, u, s0, sg };
        } catch(calcError) {
            console.error(`페트 ${p.name} 계산 중 오류:`, calcError, p);
        }
    }
    ALL_NAMES = Object.keys(GLOBAL_TABLE).sort((a,b)=>a.localeCompare(b,'ko'));
    console.log(`${currentMode} 모드 테이블 빌드 완료 (${ALL_NAMES.length}개)`);
}
// ▲▲▲▲▲ buildPetTable 수정 ▲▲▲▲▲


/* ========= DOM ========= */
const brandTitle = document.getElementById('brand-title');
const dataTimestamp = document.getElementById('data-timestamp');
const chosungBar = document.getElementById('chosung');
const chosungTokens = document.getElementById('chosungTokens');
const petList = document.getElementById('petList');
const petSearch = document.getElementById('petSearch');
const s0hp = document.getElementById('s0_hp'), s0atk= document.getElementById('s0_atk'), s0def= document.getElementById('s0_def'), s0agi= document.getElementById('s0_agi');
const sghp = document.getElementById('sg_hp'), sgatk= document.getElementById('sg_atk'), sgdef= document.getElementById('sg_def'), sgagi= document.getElementById('sg_agi');
const obshp = document.getElementById('obs_hp'), obsatk= document.getElementById('obs_atk'), obsdef= document.getElementById('obs_def'), obsagi= document.getElementById('obs_agi');
const kpiSuccess = document.getElementById('kpiSuccess'), kpiAppear  = document.getElementById('kpiAppear'), kpiTries = document.getElementById('kpiTries');
const totMatches = document.getElementById('totMatches'), rank8Matches = document.getElementById('rank8Matches');
const distBox = document.getElementById('dist');
const btnCalc = document.getElementById('btnCalc'), btnReset= document.getElementById('btnReset'), btnClear= document.getElementById('btnClear');
const btnModeHappy = document.getElementById('mode-happy');
const btnModeNova = document.getElementById('mode-nova');

let currentChosung="", selectedName=null, selectedRow=null, selectedItemEl=null;

/* ========= 초성 키패드 ========= */
const CHO = ['ㄱ','ㄴ','ㄷ','ㄹ','ㅁ','ㅂ','ㅅ','ㅇ','ㅈ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
function renderChosungTokens(){
  chosungTokens.innerHTML = "";
  for(const ch of currentChosung){
    const t = document.createElement('div');
    t.className = 'chip'; t.style.cursor = 'default'; t.textContent = ch;
    chosungTokens.appendChild(t);
  }
}
CHO.forEach(c=>{
  const chip=document.createElement('div');
  chip.className='chip'; chip.textContent=c;
  chip.addEventListener('click', ()=>{
    currentChosung += c;
    renderPetList();
    renderChosungTokens();
    Array.from(chosungBar.children).forEach(el=>el.classList.remove('on'));
    chip.classList.add('on');
  });
  chosungBar.appendChild(chip);
});
petSearch.addEventListener('input', renderPetList);

/* ========= 목록 (Badge 기능 추가) ========= */
function renderPetList(){
  const kw = (petSearch.value||"").trim();
  const names = ALL_NAMES;
  const list = names.filter(n=>{
    const a = kw? n.includes(kw): true;
    const b = currentChosung? getChosung(n).startsWith(currentChosung): true;
    return a && b;
  });

  petList.innerHTML="";
  if(list.length===0){
    const d=document.createElement('div'); d.className='item';
    d.textContent='결과 없음 (또는 데이터 로딩 중...)'; // 문구 수정
    petList.appendChild(d); return;
  }

  list.forEach(n=>{
    const div=document.createElement('div'); div.className='item';
    const left=document.createElement('div'); left.textContent = n;

    const right=document.createElement('div'); right.className="tags";
    const tag1=document.createElement('span');
    const isRegistered = !!GLOBAL_TABLE[n];
    tag1.className = 'tag ' + (isRegistered ? 'ok' : 'warn');
    tag1.textContent = isRegistered ? '등록됨' : '미등록';
    right.appendChild(tag1);

    div.appendChild(left);
    div.appendChild(right);

    div.addEventListener('click', ()=>{
      if(selectedItemEl) selectedItemEl.classList.remove('selected');
      div.classList.add('selected');
      selectedItemEl = div;
      selectPetName(n);
    });
    if (n === selectedName) { div.classList.add('selected'); selectedItemEl = div; }
    petList.appendChild(div);
  });
  renderChosungTokens();
}

/* ========= 펫 선택 ========= */
function selectPetName(n){
  selectedName=n;
  selectedRow=GLOBAL_TABLE[n]||null;

  if(selectedRow?.s0){
    s0hp.value=selectedRow.s0.hp.toFixed(2); s0atk.value=selectedRow.s0.atk.toFixed(2);
    s0def.value=selectedRow.s0.def.toFixed(2); s0agi.value=selectedRow.s0.agi.toFixed(2);
  }else{ s0hp.value=s0atk.value=s0def.value=s0agi.value=""; }

  if(selectedRow?.sg){
    sghp.value=selectedRow.sg.hp.toFixed(2); sgatk.value=selectedRow.sg.atk.toFixed(2);
    sgdef.value=selectedRow.sg.def.toFixed(2); sgagi.value=selectedRow.sg.agi.toFixed(2);
  }else{ sghp.value=sgatk.value=sgdef.value=sgagi.value=""; }

  if(selectedRow?.s0){
    obshp.value = Math.floor(selectedRow.s0.hp)||"";
    obsatk.value= Math.floor(selectedRow.s0.atk)||"";
    obsdef.value= Math.floor(selectedRow.s0.def)||"";
    obsagi.value= Math.floor(selectedRow.s0.agi)||"";
  }else{
    obshp.value=obsatk.value=obsdef.value=obsagi.value="";
  }
  showKpis(null);
}

/* ========= START: KPI 렌더링 로직 (수정 없음 - 이전과 동일) ========= */
function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
function resolveR(el){
  const rSelf = parseFloat(el.getAttribute('r'));
  if (isFinite(rSelf)) return rSelf;
  const href = el.getAttribute('href') || el.getAttribute('xlink:href');
  if (href && href[0]==='#'){
    const ref = el.ownerSVGElement?.getElementById(href.slice(1));
    const rr = parseFloat(ref && ref.getAttribute('r'));
    if (isFinite(rr)) return rr;
  }
  return 45;
}
function makeRing(fillEl, maskStrokeEl, colorGetter){
  if (!fillEl) return { setFrac: () => {}, C: 0 };
  const r = resolveR(fillEl);
  const C = 2 * Math.PI * r;
  const baseStroke = fillEl.style.stroke || fillEl.getAttribute('stroke') || '#fff';
  const strokeOn  = (col)=>{ fillEl.style.stroke = col || (colorGetter? colorGetter(): baseStroke); };
  const strokeOff = ()=>{ fillEl.style.stroke = 'none'; };
  const clamp01 = (x)=> (Number.isFinite(x)? Math.max(0, Math.min(1,x)) : 0);

  function setFrac(frac){
    const f = clamp01(frac);
    if (f === 0){
      fillEl.setAttribute('stroke-dasharray','0 1');
      fillEl.setAttribute('stroke-dashoffset','0');
      if(maskStrokeEl){
        maskStrokeEl.setAttribute('stroke-dasharray','0 1');
        maskStrokeEl.setAttribute('stroke-dashoffset','0');
      }
      strokeOff();
      return;
    }
    const dash=C, gap=C, off=(1-f)*C;
    fillEl.setAttribute('stroke-dasharray', `${dash} ${gap}`);
    fillEl.setAttribute('stroke-dashoffset', `${off}`);
    if(maskStrokeEl){
      maskStrokeEl.setAttribute('stroke-dasharray', `${dash} ${gap}`);
      maskStrokeEl.setAttribute('stroke-dashoffset', `${off}`);
    }
    strokeOn();
  }
  return { setFrac, C };
}
function polar0(cx,cy,r,deg){ const t=(deg-90)*Math.PI/180; return [cx + r*Math.cos(t), cy + r*Math.sin(t)]; }
function arcPath0(cx,cy,r,deg0,deg1){
  let s=deg0, e=deg1; while(e<s) e+=360;
  const span=e-s;
  if (Math.abs(span - 360) < 0.001) {
      const midDeg = s + 180;
      const [x0,y0]=polar0(cx,cy,r,s);
      const [xm,ym]=polar0(cx,cy,r,midDeg);
      const [x1,y1]=polar0(cx,cy,r,e);
      return `M ${x0} ${y0} A ${r} ${r} 0 0 1 ${xm} ${ym} A ${r} ${r} 0 0 1 ${x1} ${y1}`;
  }
  const large=span>180?1:0;
  const [x0,y0]=polar0(cx,cy,r,s), [x1,y1]=polar0(cx,cy,r,e);
  return `M ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1}`;
}

const succFill = document.getElementById('succFill');
const succMaskStroke = document.getElementById('succMaskStroke');
const { setFrac: _succSetFrac } = makeRing(succFill, succMaskStroke, ()=>getCSS('--accent'));
const hud = document.getElementById('succHUD');
const tail= document.getElementById('succTail');
const core= document.getElementById('succCore');
const flare= document.getElementById('succFlare');
const SUCCR = resolveR(succFill);
let head=0, run=false, lastTs=0, animFrameId = null;

function tick(ts){
  if(!run) return;
  if(!lastTs) lastTs=ts;
  const dt=(ts-lastTs)/1000; lastTs=ts;
  const circum=2*Math.PI*SUCCR, pxPerSec=parseFloat(getCSS('--hud-speed'))||120;
  const degPerSec=(pxPerSec/circum)*360;
  head=(head + degPerSec*dt) % 360;

  if (tail) {
      const TAIL_SPAN=360*0.22;
      tail.setAttribute('d', arcPath0(50,50,SUCCR, head-TAIL_SPAN, head));
  }
  if (core) {
      const CORE_SPAN=360*0.10;
      core.setAttribute('d', arcPath0(50,50,SUCCR, head-CORE_SPAN, head));
  }
  if (flare) {
      const [fx,fy]=polar0(50,50,SUCCR, head);
      flare.setAttribute('cx', fx.toFixed(2)); flare.setAttribute('cy', fy.toFixed(2));
  }
  animFrameId = requestAnimationFrame(tick);
}
function setSuccess(pct){
  const f = Math.max(0, Math.min(100, Number(pct)||0))/100;
  _succSetFrac(f);
  if (kpiSuccess) kpiSuccess.textContent = (f*100).toFixed(4) + '%';
  if(f<=0){
    if (hud) hud.style.opacity=0;
    run=false; lastTs=0; head=0;
    cancelAnimationFrame(animFrameId);
    if (tail) tail.setAttribute('d','');
    if (core) core.setAttribute('d','');
  }else{
    if (hud) hud.style.opacity=1;
    if(!run){ run=true; lastTs=0; animFrameId = requestAnimationFrame(tick); }
  }
}

const apFill = document.getElementById('apFill');
const { setFrac: _apSetFrac } = makeRing(apFill, null, ()=> '#7fd4ff');
const apBadge = document.getElementById('apBadge');
function setAppear(pctReal){
  const p = Math.max(0, Number(pctReal)||0);
  const frac = Math.min(p, 2) / 2;
  _apSetFrac(frac);
  if (kpiAppear) kpiAppear.textContent = p.toFixed(6) + '%';
  if (apBadge) apBadge.style.display = (p>2 ? '' : 'none');
}

const trFill = document.getElementById('trFill');
function colorByTries(x){
  return (x<=5)  ? getCSS('--ok')
       : (x<=20) ? getCSS('--warn')
       :           getCSS('--bad');
}
const { setFrac: _trSetFrac } = makeRing(trFill, null, ()=> colorByTries(currTries));
let currTries = 1;
function setTries(t){
  currTries = Math.max(1, Number(t)||1);
  let frac;
  if(currTries>=200) frac=1;
  else{
    const logMin = Math.log10(1);
    const logMax = Math.log10(200);
    const r = (Math.log10(currTries)-logMin) / (logMax-logMin);
    frac = Math.max(0, Math.min(1, r || 0));
  }
  if (trFill) trFill.style.stroke = colorByTries(currTries);
  _trSetFrac(frac);
  if (kpiTries) kpiTries.textContent = (Number.isFinite(t)? Math.round(currTries) : '—');
}

function showKpis(res){
  if(!res){
    setSuccess(0);
    setAppear(0);
    setTries(1);
    if (totMatches) totMatches.textContent = "—";
    if (rank8Matches) rank8Matches.textContent = "—";
    if (distBox) distBox.innerHTML = "";
    return;
  }

  const matches = res.matches|0;
  const rank8   = res.rank8|0;
  const appear  = matches/TOTAL*100;
  const successPct = matches ? (rank8/matches*100) : 0;
  const tries = successPct > 0 ? (100/successPct) : Infinity;

  setSuccess(successPct);
  setAppear(appear);
  setTries(isFinite(tries) ? tries : 200);

  if (totMatches) totMatches.textContent   = matches.toLocaleString();
  if (rank8Matches) rank8Matches.textContent = rank8.toLocaleString();

  const entries = Object.entries(res.dist)
    .map(([r,c]) => ({r:parseInt(r,10), c}))
    .sort((a,b) => b.r - a.r || b.c - a.c);

  let html = `<table class="table"><thead><tr><th>등급(베이스합)</th><th>건수</th><th>비율</th></tr></thead><tbody>`;
  const total = matches || 1;
  entries.forEach(e=>{
    const pct = (e.c/total*100).toFixed(2);
    const cls = (e.r===8 ? "ok" : (e.r>=5 ? "warn" : ""));
    html += `<tr><td class="${cls}">${e.r}</td><td>${e.c.toLocaleString()}</td><td>${pct}%</td></tr>`;
  });
  html += `</tbody></table>`;
  if (distBox) distBox.innerHTML = html;
}
/* ========= END: KPI 렌더링 로직 교체 ========= */


/* ========= 관측치 편의 ========= */
function enableWheelStep(el){
  el.addEventListener('wheel',(e)=>{
    if(document.activeElement!==el) return;
    e.preventDefault();
    const delta = e.deltaY<0? 1 : -1;
    const curr = parseInt(el.value||"0",10);
    if (!isNaN(curr)) {
        el.value = String(curr + delta);
    } else {
        el.value = String(delta > 0 ? 1 : -1);
    }
  }, {passive:false});
}
[obsatk,obshp,obsdef,obsagi].forEach(enableWheelStep);
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-delta][data-target]'); if(!btn) return;
  const id = btn.getAttribute('data-target'); const delta = parseInt(btn.getAttribute('data-delta'),10);
  const input=document.getElementById(id); if(!input) return;
  const curr=parseInt(input.value||"0",10);
  if (!isNaN(curr)) {
      input.value=String(curr+delta);
  } else {
      input.value = String(delta > 0 ? 1 : -1);
  }
});

/* ========= 엔진(합산 후 floor) - 꼬비아빠 로직 (원본 유지) ========= */
function enumerate_kkoby(pku, obs){
  const k = new Decimal(pku.k);
  const fac = k.dividedBy(100);
  const u = pku.u;

  let matches = 0, rank8 = 0;
  const dist = {};

  const baseCnt = 5;
  const baseInit = -2;

  Decimal.set({ precision: 50, rounding: Decimal.ROUND_HALF_UP });

  for(let hr=baseInit; hr<baseInit+baseCnt; hr++){
    for(let ar=baseInit; ar<baseInit+baseCnt; ar++){
      for(let dr=baseInit; dr<baseInit+baseCnt; dr++){
        for(let gr=baseInit; gr<baseInit+baseCnt; gr++){
          for(let hb=0; hb<=10; hb++){
            for(let ab=0; ab<=10; ab++){
              for(let db=0; db<=10; db++){
                const gb = 10 - hb - ab - db;
                if(gb < 0 || gb > 10) continue;

                const baseH = new Decimal(u.hp + hr + hb);
                const baseA = new Decimal(u.atk + ar + ab);
                const baseD = new Decimal(u.def + dr + db);
                const baseG = new Decimal(u.agi + gr + gb);

                const iH = baseH.times(fac); const iA = baseA.times(fac);
                const iD = baseD.times(fac); const iG = baseG.times(fac);

                const preciseRound = (num) => num.toDP(12, Decimal.ROUND_HALF_UP);

                const r_hp = preciseRound(iH); const r_atk = preciseRound(iA);
                const r_def = preciseRound(iD); const r_agi = preciseRound(iG);

                const calcHp  = preciseRound(r_hp.times(4).plus(r_atk).plus(r_def).plus(r_agi)).floor().toNumber();
                const calcAtk = preciseRound(r_hp.times('0.1').plus(r_atk).plus(r_def.times('0.1')).plus(r_agi.times('0.05'))).floor().toNumber();
                const calcDef = preciseRound(r_hp.times('0.1').plus(r_atk.times('0.1')).plus(r_def).plus(r_agi.times('0.05'))).floor().toNumber();
                const calcAgi = preciseRound(r_agi).floor().toNumber();


                if(calcHp===obs[0] && calcAtk===obs[1] && calcDef===obs[2] && calcAgi===obs[3]){
                  matches++;
                  const r = hr + ar + dr + gr;
                  dist[r] = (dist[r]||0) + 1;
                  if(r === 8) rank8++;
                }
              }
            }
          }
        }
      }
    }
  }
  Decimal.set({ precision: 20 });

  return {matches, rank8, dist};
}

/* ========= 계산 및 리셋 ========= */
btnCalc.addEventListener('click', ()=>{
  if(!selectedName){ alert("펫을 먼저 선택하세요."); return; }
  const obs=[obshp,obsatk,obsdef,obsagi].map(e=>parseInt(e.value,10));
  if(obs.some(v=>!Number.isFinite(v))){ alert("관측 표기치(정수)를 모두 입력하세요."); return; }

  const row=GLOBAL_TABLE[selectedName]||{};
  if(!row || typeof row.k !== 'number' || !row.u || typeof row.u.hp !== 'number'){
      alert("선택된 펫의 데이터(k/u)가 올바르지 않습니다. 데이터 로딩이 완료되었는지 확인하세요.");
      console.error("Invalid pet data for calculation:", selectedName, row);
      return;
  }

  const res = enumerate_kkoby({k: row.k, u: row.u}, obs);
  showKpis(res);
});

function resetAll(){
    selectedName=null; selectedRow=null;
    petSearch.value=""; currentChosung="";
    Array.from(chosungBar.children).forEach(el=>el.classList.remove('on'));
    if (selectedItemEl) {
        selectedItemEl.classList.remove('selected');
        selectedItemEl = null;
    }
    renderChosungTokens();
    renderPetList();
    [s0hp,s0atk,s0def,s0agi,sghp,sgatk,sgdef,sgagi,obshp,obsatk,obsdef,obsagi].forEach(i=>i.value="");
    showKpis(null);
}

btnReset.addEventListener('click', resetAll);

btnClear.addEventListener('click', ()=>{
  petSearch.value=""; currentChosung="";
  Array.from(chosungBar.children).forEach(el=>el.classList.remove('on'));
  if (selectedItemEl) {
    selectedItemEl.classList.remove('selected');
    selectedItemEl = null;
  }
  renderChosungTokens();
  renderPetList();
});

/* ========= 모드 전환 (수정됨: async 및 fetch 사용) ========= */
async function switchMode(mode) {
    if (currentMode === mode) return;

    // 로딩 시작 표시
    btnModeHappy.disabled = true;
    btnModeNova.disabled = true;
    brandTitle.textContent = `${mode.charAt(0).toUpperCase() + mode.slice(1)} 데이터 로딩 중...`;
    dataTimestamp.textContent = "";

    currentMode = mode;
    const dataUrl = (mode === 'happy') ? happyDataUrl : novaDataUrl;
    // 임시 타임스탬프 (나중에 JSON 파일 자체에 넣는 것을 고려)
    // ▼▼▼▼▼ 타임스탬프는 예시로 남겨두되, 실제 값은 비워둠 ▼▼▼▼▼
    const tempTimestamp = ""; // (예: "2025.10.18") - 필요시 실제 날짜 넣기
    // ▲▲▲▲▲ 타임스탬프 수정 ▲▲▲▲▲

    try {
        const response = await fetch(dataUrl + `?v=${Date.now()}`); // 캐시 방지
        if (!response.ok) {
            throw new Error(`HTTP 오류! 상태: ${response.status} - ${response.statusText}. 파일 경로(${dataUrl}) 확인 필요.`);
        }
        const petList = await response.json();

        // JSON 데이터가 배열인지 확인
        if (!Array.isArray(petList)) {
             throw new Error(`로드된 데이터(${dataUrl})가 배열 형식이 아닙니다.`);
        }

        petData[currentMode] = {
            timestamp: tempTimestamp, // 임시 타임스탬프 사용
            list: petList
        };
        console.log(`${mode} 데이터 로드 및 파싱 성공! (${petList.length}개)`);

        buildPetTable(); // 데이터 로드 *후* 테이블 빌드

        // UI 업데이트
        if (mode === 'happy') {
            document.body.classList.remove('light');
            brandTitle.textContent = "꼬비아빠 놀이터 (Happy)";
            // ▼▼▼▼▼ 타임스탬프 표시 수정 ▼▼▼▼▼
            dataTimestamp.textContent = tempTimestamp ? `데이터 기준 ${tempTimestamp}` : 'Happy 데이터';
            // ▲▲▲▲▲ 타임스탬프 표시 수정 ▲▲▲▲▲
            btnModeHappy.classList.add('active');
            btnModeNova.classList.remove('active');
        } else { // nova
            document.body.classList.add('light');
            brandTitle.textContent = "꼬비아빠 놀이터 (Nova)";
            // ▼▼▼▼▼ 타임스탬프 표시 수정 ▼▼▼▼▼
            dataTimestamp.textContent = tempTimestamp ? `데이터 기준 ${tempTimestamp}` : 'Nova 데이터';
            // ▲▲▲▲▲ 타임스탬프 표시 수정 ▲▲▲▲▲
            btnModeNova.classList.add('active');
            btnModeHappy.classList.remove('active');
        }

        resetAll(); // UI 초기화 (목록 다시 그리기 포함)

    } catch (error) {
        console.error(`페트 데이터 (${mode}) 로딩 실패:`, error);
        alert(`${mode} 페트 데이터를 불러오는 중 오류가 발생했습니다: ${error.message}. 개발자 도구 콘솔을 확인해주세요.`);
        brandTitle.textContent = `${mode} 데이터 로드 오류`;
        petData[currentMode] = { timestamp: "오류", list: [] };
        buildPetTable();
        resetAll();
    } finally {
        // 로딩 완료 후 버튼 활성화
        btnModeHappy.disabled = false;
        btnModeNova.disabled = false;
    }
}

btnModeHappy.addEventListener('click', () => switchMode('happy'));
btnModeNova.addEventListener('click', () => switchMode('nova'));


/* ========= 부팅 (수정됨: async 및 await 사용) ========= */
(async function init(){
  // 초기 UI 렌더링 (초성 버튼 등)
  CHO.forEach(c=>{
      const chip=document.createElement('div');
      chip.className='chip'; chip.textContent=c;
      chip.addEventListener('click', ()=>{ /* ... 클릭 이벤트 ... */ });
      chosungBar.appendChild(chip);
  }); // init 함수 안으로 이동
  // 기본 모드(happy) 데이터 로딩 시작
  await switchMode('happy');
})();
</script>
</body>
</html>
